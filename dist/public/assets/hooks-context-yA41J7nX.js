const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/services-DrymXMI4.js","assets/css-utils-BkLtITBR.js","assets/vendor-BXT5a8vO.js","assets/react-core-C6DwaHZM.js","assets/ui-vendor-BQCqNqg0.js","assets/charts-ceMktdbA.js","assets/charts-utils-DdC1WR7j.js","assets/components-BqWspkJD.js","assets/siri-components-BtflWmbM.js","assets/siri-components-GqxCBkk7.css","assets/react-router-B7s-G-0E.js","assets/components-BlTBQwkB.css"])))=>i.map(i=>d[i]);
import{r as e,j as L,R as G,aP as Ve,aQ as Ue}from"./react-core-C6DwaHZM.js";import{I as Z,u as de}from"./components-BqWspkJD.js";import{g as $,i as Be}from"./services-DrymXMI4.js";import{j as qe}from"./validation-VWaDGczM.js";const We=function(){const n=typeof document<"u"&&document.createElement("link").relList;return n&&n.supports&&n.supports("modulepreload")?"modulepreload":"preload"}(),$e=function(o){return"/"+o},he={},j=function(n,t,i){let c=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const g=document.querySelector("meta[property=csp-nonce]"),l=g?.nonce||g?.getAttribute("nonce");c=Promise.allSettled(t.map(m=>{if(m=$e(m),m in he)return;he[m]=!0;const S=m.endsWith(".css"),p=S?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${p}`))return;const r=document.createElement("link");if(r.rel=S?"stylesheet":We,S||(r.as="script"),r.crossOrigin="",r.href=m,l&&r.setAttribute("nonce",l),document.head.appendChild(r),S)return new Promise((s,a)=>{r.addEventListener("load",s),r.addEventListener("error",()=>a(new Error(`Unable to preload CSS for ${m}`)))})}))}function d(g){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=g,window.dispatchEvent(l),!l.defaultPrevented)throw g}return c.then(g=>{for(const l of g||[])l.status==="rejected"&&d(l.reason);return n().catch(d)})},Ge=1,ze=1e6;let ie=0;function je(){return ie=(ie+1)%Number.MAX_SAFE_INTEGER,ie.toString()}const ce=new Map,Ce=o=>{if(ce.has(o))return;const n=setTimeout(()=>{ce.delete(o),z({type:"REMOVE_TOAST",toastId:o})},ze);ce.set(o,n)},Ke=(o,n)=>{switch(n.type){case"ADD_TOAST":return{...o,toasts:[n.toast,...o.toasts].slice(0,Ge)};case"UPDATE_TOAST":return{...o,toasts:o.toasts.map(t=>t.id===n.toast.id?{...t,...n.toast}:t)};case"DISMISS_TOAST":{const{toastId:t}=n;return t?Ce(t):o.toasts.forEach(i=>{Ce(i.id)}),{...o,toasts:o.toasts.map(i=>i.id===t||t===void 0?{...i,open:!1}:i)}}case"REMOVE_TOAST":return n.toastId===void 0?{...o,toasts:[]}:{...o,toasts:o.toasts.filter(t=>t.id!==n.toastId)}}},ee=[];let te={toasts:[]};function z(o){te=Ke(te,o),ee.forEach(n=>{n(te)})}function Ye({...o}){const n=je(),t=c=>z({type:"UPDATE_TOAST",toast:{...c,id:n}}),i=()=>z({type:"DISMISS_TOAST",toastId:n});return z({type:"ADD_TOAST",toast:{...o,id:n,open:!0,onOpenChange:c=>{c||i()}}}),{id:n,dismiss:i,update:t}}function gt(){const[o,n]=e.useState(te);return e.useEffect(()=>(ee.push(n),()=>{const t=ee.indexOf(n);t>-1&&ee.splice(t,1)}),[o]),{...o,toast:Ye,dismiss:t=>z({type:"DISMISS_TOAST",toastId:t})}}const ht=120,Ct=350,yt=20,St={conversation:{icon:"🔴",title:"Conversation",color:"#FF3B30",bgColor:"rgba(255, 59, 48, 0.1)"},staff:{icon:"💬",title:"Staff Messages",color:"#007AFF",bgColor:"rgba(0, 122, 255, 0.1)"},notification:{icon:"📢",title:"Hotel Notifications",color:"#FF9500",bgColor:"rgba(255, 149, 0, 0.1)"},alert:{icon:"⚠️",title:"Alert",color:"#FF3B30",bgColor:"rgba(255, 59, 48, 0.1)"},order:{icon:"🛎️",title:"Room Service",color:"#5856D6",bgColor:"rgba(88, 86, 214, 0.1)"},summary:{icon:"📋",title:"Call Summary",color:"#34C759",bgColor:"rgba(52, 199, 89, 0.1)"}},Se=e.createContext(null);let Je=0;const Et=({children:o})=>{const[n,t]=e.useState([]),[i,c]=e.useState(null),d=e.useCallback(s=>{const a=`popup-${++Je}`,h={...s,id:a,timestamp:new Date};return t(f=>{if(s.priority==="high"){const E=f.filter(C=>C.type!==s.type);return[h,...E]}return[h,...f]}),(s.priority==="high"||s.isActive)&&c(a),a},[]),g=e.useCallback(s=>{t(a=>a.filter(h=>h.id!==s)),c(a=>a===s?null:a)},[]),l=e.useCallback(s=>{c(s),s&&t(a=>a.map(h=>({...h,isActive:h.id===s})))},[]),m=e.useCallback((s,a)=>{t(h=>h.map(f=>f.id===s?{...f,...a}:f))},[]),S=e.useCallback(()=>{t([]),c(null)},[]),p=e.useCallback(s=>n.filter(a=>a.type===s),[n]),r={popups:n,activePopup:i,addPopup:d,removePopup:g,setActivePopup:l,updatePopup:m,clearAllPopups:S,getPopupsByType:p};return L.jsx(Se.Provider,{value:r,children:o})},Qe=()=>{const o=e.useContext(Se);return o||(console.warn("usePopupContext used outside PopupProvider - returning safe defaults"),{popups:[],activePopup:null,addPopup:()=>"",removePopup:()=>{},setActivePopup:()=>{},updatePopup:()=>{},clearAllPopups:()=>{},getPopupsByType:()=>[]})},Xe={"hotel-manager":{dashboard:["view","edit"],analytics:["view","export"],calls:["view","manage"],requests:["view","manage"]},"front-desk":{dashboard:["view"],calls:["view"],requests:["view","manage"]},"it-manager":{dashboard:["view"],system:["view","debug"],calls:["view"]},admin:{dashboard:["view","edit"],analytics:["view","export"],calls:["view","manage"],requests:["view","manage"]},staff:{dashboard:["view"],requests:["view"]},manager:{dashboard:["view","edit"],analytics:["view","export"],calls:["view","manage"],requests:["view","manage"]},frontdesk:{dashboard:["view"],calls:["view"],requests:["view","manage"]},itmanager:{dashboard:["view"],system:["view","debug"],calls:["view"]},"super-admin":{dashboard:["view","edit"],analytics:["view","export"],calls:["view","manage"],requests:["view","manage"],system:["view","debug","manage"]}},Ze=o=>{const n=Xe[o]||{},t=[];for(const[i,c]of Object.entries(n))for(const d of c)t.push({module:i,action:d,allowed:!0});return t},Ee=e.createContext(void 0),vt=()=>{const o=e.useContext(Ee);return o===void 0?(console.warn("useAuth used outside AuthProvider - returning safe defaults"),{user:null,tenant:null,isLoading:!1,isAuthenticated:!1,login:async()=>{},logout:()=>{},hasPermission:()=>!1,hasRole:()=>!1,refreshAuth:async()=>{},hasFeature:()=>!1,isWithinLimits:()=>!0}):o},et=o=>{switch(o){case"admin":case"manager":case"hotel-manager":return"hotel-manager";case"staff":case"front-desk":return"front-desk";case"it":case"tech":case"it-manager":return"it-manager";default:return"front-desk"}},wt=({children:o})=>{console.log("[DEBUG] AuthProvider render");const[n,t]=e.useState(null),[i,c]=e.useState(null),[d,g]=e.useState(!0);e.useEffect(()=>{console.log("[DEBUG] AuthProvider useEffect - checking token");const r=localStorage.getItem("token");if(!r){console.log("[DEBUG] AuthProvider - no token found, setting loading false"),g(!1);return}try{console.log("[DEBUG] AuthProvider - decoding token");const s=qe(r);console.log("[DEBUG] AuthProvider - token decoded:",s);const a=et(s.role),h={id:s.username,name:s.username,email:s.username,tenantId:s.tenantId,role:a,permissions:Ze(a)},f={id:s.tenantId,hotelName:"Mi Nhon Hotel",subdomain:"minhonmuine",subscriptionPlan:"premium",subscriptionStatus:"active"};t(h),c(f)}catch(s){console.log("[DEBUG] AuthProvider - token decode error:",s),localStorage.removeItem("token")}finally{console.log("[DEBUG] AuthProvider - setting loading false"),g(!1)}},[]);const l=e.useCallback(async(r,s)=>{g(!0);try{const a=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:r,password:s})});if(!a.ok)throw new Error("Sai tài khoản hoặc mật khẩu");const h=await a.json();if(!h.success||!h.token)throw new Error("Không nhận được token từ server");localStorage.setItem("token",h.token);const f={id:h.user.id,name:h.user.displayName||h.user.username,email:h.user.email,tenantId:h.user.tenantId,role:h.user.role,permissions:h.user.permissions||[]},E={id:h.user.tenantId,hotelName:"Mi Nhon Hotel",subdomain:"minhonmuine",subscriptionPlan:"premium",subscriptionStatus:"active"};t(f),c(E)}catch(a){throw localStorage.removeItem("token"),t(null),c(null),a}finally{g(!1)}},[]),m=e.useCallback(()=>{console.log("[DEBUG] AuthProvider logout called"),t(null),c(null),localStorage.removeItem("token"),window.location.href="/login"},[]),S=e.useCallback((r,s)=>!n||!n.permissions?!1:n.permissions.some(a=>a.module===r&&a.action===s&&a.allowed),[n]),p=e.useCallback(r=>n?.role===r,[n]);return console.log("[DEBUG] AuthProvider state:",{user:n,tenant:i,isLoading:d}),L.jsx(Ee.Provider,{value:{user:n,tenant:i,isLoading:d,login:l,logout:m,isAuthenticated:!!n,refreshAuth:async()=>{},hasFeature:()=>!1,hasRole:p,hasPermission:S,isWithinLimits:()=>!0},children:o})},tt=()=>{const[o,n]=e.useState(null);return e.useEffect(()=>{if(typeof window>"u")return;const t=window.location.hostname,i=t==="localhost"||t==="127.0.0.1",c=/^\d+\.\d+\.\d+\.\d+$/.test(t),d=t==="talk2go.online"||t==="www.talk2go.online";let g=null,l=!1,m;if(!i&&!c&&!d)if(t.includes(".talk2go.online")){const p=t.split(".");p.length>2&&(g=p[0],l=!0)}else m=t,l=!1;n({subdomain:g,isMiNhon:i||t==="minhotel.talk2go.online"||t==="talk2go.online"||t==="www.talk2go.online"||g==="minhon",isSubdomain:l,customDomain:m})},[]),o},ye={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},Q={hotelName:"Mi Nhon Hotel Mui Ne",logoUrl:"/assets/references/images/minhon-logo.jpg",primaryColor:"#2C3E50",headerText:"Mi Nhon Hotel Mui Ne",vapiPublicKey:"",vapiAssistantId:"",branding:{logo:"/assets/references/images/minhon-logo.jpg",colors:{primary:"#2C3E50",secondary:"#34495E",accent:"#E74C3C"},fonts:{primary:"Poppins",secondary:"Inter"}},features:{callHistory:!0,multiLanguage:!0,analytics:!0,customization:!0},services:[{type:"room_service",name:"Room Service",enabled:!0},{type:"concierge",name:"Concierge",enabled:!0},{type:"housekeeping",name:"Housekeeping",enabled:!0},{type:"maintenance",name:"Maintenance",enabled:!0},{type:"restaurant",name:"Restaurant",enabled:!0}],supportedLanguages:["en","fr","zh","ru","ko","vi"]},ve=()=>{console.log("[DEBUG] useHotelConfiguration hook called");const[o,n]=e.useState(null),[t,i]=e.useState(!0),[c,d]=e.useState(null);tt();const g=()=>{const m=window.location.hostname;if(m==="localhost"||m==="127.0.0.1")return{type:"default",identifier:"mi-nhon-hotel"};const p=m.split(".");return p.length>=3&&p[p.length-2]==="talk2go"&&p[p.length-1]==="online"?{type:"subdomain",identifier:p[0]}:{type:"custom",identifier:m}},l=e.useCallback(async()=>{console.log("[DEBUG] loadConfiguration called");try{i(!0),d(null);const{type:m,identifier:S}=g();if(console.log("[DEBUG] extractHotelIdentifier",{type:m,identifier:S}),m==="default"){n(Q);return}if(m==="subdomain"){const p=`/api/hotels/by-subdomain/${S}`;console.log("[DEBUG] Fetching hotel config from",p);try{const r=await fetch(p);if(console.log("[DEBUG] fetch response",r),!r.ok)throw new Error("Failed to load hotel configuration");const s=await r.json();console.log("[DEBUG] hotelData",s),n({hotelName:s.name,logoUrl:s.branding.logo,primaryColor:s.branding.primaryColor,headerText:s.name,vapiPublicKey:"",vapiAssistantId:"",branding:{...s.branding,colors:{primary:s.branding.primaryColor||"#2C3E50",secondary:s.branding.secondaryColor||"#34495E",accent:s.branding.accentColor||"#E74C3C"},fonts:{primary:s.branding.PrimaryFont||"Inter",secondary:s.branding.SecondaryFont||"Roboto"}},features:s.features,services:s.services,supportedLanguages:s.supportedLanguages});return}catch(r){console.error("[DEBUG] fetch hotel config error",r),n(Q);return}}n(Q)}catch(m){d(m instanceof Error?m.message:"Failed to load configuration"),n(Q)}finally{i(!1)}},[]);return e.useEffect(()=>{l()},[l]),{config:o,isLoading:t,error:c,reload:l,isMiNhon:!1}},X={},we=async o=>{if(X[o])return X[o];try{const n=await fetch(`/api/vapi/config/${o}`);if(!n.ok)throw new Error(`Failed to fetch Vapi config: ${n.status}`);const t=await n.json();return console.log(`🔧 [fetchVapiConfig] Received config for ${o}:`,{publicKey:t.publicKey?t.publicKey.substring(0,10)+"...":"NOT SET",assistantId:t.assistantId?t.assistantId.substring(0,10)+"...":"NOT SET",fallback:t.fallback}),X[o]=t,t}catch(n){console.error(`[fetchVapiConfig] Error fetching Vapi config for ${o}:`,n);const t={publicKey:o==="en"?"":ye[`VITE_VAPI_PUBLIC_KEY_${o.toUpperCase()}`]||void 0||"",assistantId:o==="en"?"":ye[`VITE_VAPI_ASSISTANT_ID_${o.toUpperCase()}`]||void 0||"",fallback:!0};return console.log(`[fetchVapiConfig] Using fallback config for ${o}:`,{publicKey:t.publicKey?t.publicKey.substring(0,10)+"...":"NOT SET",assistantId:t.assistantId?t.assistantId.substring(0,10)+"...":"NOT SET"}),X[o]=t,t}},nt=async(o,n)=>{if(n.hotelName==="Mi Nhon Hotel Mui Ne")try{return(await we(o)).publicKey||n.vapiPublicKey}catch(t){return console.error(`[getVapiPublicKeyByLanguage] Error for ${o}:`,t),n.vapiPublicKey}return n.vapiPublicKey||void 0},ot=async(o,n)=>{if(n.hotelName==="Mi Nhon Hotel Mui Ne")try{const t=await we(o);return console.log(`🤖 [getVapiAssistantIdByLanguage] Selected assistant for ${o}:`,{assistantId:t.assistantId?t.assistantId.substring(0,10)+"...":"NOT SET",fallback:t.fallback}),t.assistantId||n.vapiAssistantId}catch(t){return console.error(`[getVapiAssistantIdByLanguage] Error for ${o}:`,t),n.vapiAssistantId}return n.vapiAssistantId||void 0},st={orderType:"Room Service",deliveryTime:"asap",roomNumber:"",guestName:"",guestEmail:"",guestPhone:"",specialInstructions:"",items:[{id:"1",name:"Club Sandwich",description:"Served with french fries and side salad",quantity:1,price:15},{id:"2",name:"Fresh Orange Juice",description:"Large size",quantity:1,price:8}],totalAmount:23},be=e.createContext(void 0);function bt({children:o}){console.log("[DEBUG] AssistantProvider render");const[n,t]=e.useState([]),[i,c]=e.useState(null),[d,g]=e.useState(null),[l,m]=e.useState(null),[S,p]=e.useState(0),[r,s]=e.useState(null),[a,h]=e.useState(!1),[f,E]=e.useState(null),[C,A]=e.useState([]),[P,R]=e.useState(null),[M,U]=e.useState(!1),[K,oe]=e.useState(null),[V,Y]=e.useState(!1),q=e.useRef(!0),[se,J]=e.useState([]),re=e.useCallback(u=>(J(y=>[...y,u]),()=>{J(y=>y.filter(w=>w!==u))}),[]),[k,H]=e.useState(()=>{if(typeof window>"u")return[];try{const u=localStorage.getItem("activeOrders");return u?JSON.parse(u).map(w=>({...w,requestedAt:new Date(w.requestedAt)})):[]}catch(u){return console.error("Failed to parse activeOrders from localStorage",u),[]}}),[me,Ae]=e.useState(0),[pe,ae]=e.useState([]),[T,Te]=e.useState(()=>{if(typeof window<"u"){const u=localStorage.getItem("selectedLanguage");if(u&&["en","fr","zh","ru","ko","vi"].includes(u))return console.log("🌍 [AssistantContext] Loading saved language:",u),u}return console.log("🌍 [AssistantContext] Using default language: en"),"en"}),[N,Ie]=e.useState(null),[O,xe]=e.useState(null),[fe,Re]=e.useState(null),ke=G.useCallback(u=>{console.log("🌍 [AssistantContext] setLanguage called with:",u),Te(u),typeof window<"u"&&(localStorage.setItem("selectedLanguage",u),console.log("🌍 [AssistantContext] Language saved to localStorage:",u))},[]),De=u=>{console.log("🗑️ AssistantContext: setOrder called with:",u),console.log("🗑️ Previous order:",l),m(u),console.log("✅ AssistantContext: setOrder completed")};e.useEffect(()=>{if(!(typeof window>"u"))try{localStorage.setItem("activeOrders",JSON.stringify(k))}catch{console.error("Failed to persist activeOrders to localStorage")}},[k]),e.useEffect(()=>{},[l]),e.useEffect(()=>{},[k]),e.useEffect(()=>{},[N]),e.useEffect(()=>{},[T]),e.useEffect(()=>{},[d]),e.useEffect(()=>{},[n]),e.useEffect(()=>{},[i]),e.useEffect(()=>{},[f]),e.useEffect(()=>{},[C]),e.useEffect(()=>{},[pe]),e.useEffect(()=>{},[me]),e.useEffect(()=>{},[a]),e.useEffect(()=>{},[S]),e.useEffect(()=>{},[M]),e.useEffect(()=>{},[K]),e.useEffect(()=>{},[P]),e.useEffect(()=>{},[O]),e.useEffect(()=>{},[fe]);const Pe=u=>{H(y=>[...y,{...u,status:u.status||"Đã ghi nhận"}])},Oe=G.useCallback(u=>{const y={...u,callId:d?.id||`call-${Date.now()}`,timestamp:new Date,tenantId:O||"default"};t(I=>[...I,y]),(async()=>{try{const I=await fetch("/api/transcripts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({callId:y.callId,role:y.role,content:y.content,tenantId:y.tenantId})});if(!I.ok)throw new Error(`Failed to save transcript: ${I.status}`);const b=await I.json();console.log("Transcript saved to database:",b)}catch(I){console.error("Error saving transcript to server:",I)}})()},[d?.id,O]);e.useEffect(()=>{if(V){console.log("🛑 [setupVapi] Skipping Vapi initialization - call is ending");return}return(async()=>{try{console.log("🔧 [setupVapi] Language changed to:",T),console.log("🔧 [setupVapi] Hotel config available:",!!N);const y=N?await nt(T,N):void 0;if(console.log("🔑 [setupVapi] Selected publicKey for language",T,":",y?y.substring(0,10)+"...":"undefined"),!y)throw new Error("Vapi public key is not configured");const w=await Be(y);let I=0;const b=100;w.on("volume-level",v=>{try{const D=Date.now();D-I>b&&(Ae(v),I=D)}catch(D){console.warn("Error handling volume-level:",D)}});const x=v=>{try{if(typeof window<"u"&&window.WebSocket){const D=window.location.origin.replace("http","ws")+"/ws",F=new WebSocket(D);F.onopen=()=>{F.send(JSON.stringify({type:"transcript",call_id:v.callId,role:v.role,content:v.content,timestamp:v.timestamp})),F.close()},F.onerror=le=>{console.warn("Failed to send transcript to WebSocket:",le)}}}catch(D){console.warn("Error sending transcript to WebSocket:",D)}},W=async v=>{if(console.log("Raw message received:",v),console.log("Message type:",v.type),console.log("Message role:",v.role),console.log("Message content structure:",{content:v.content,text:v.text,transcript:v.transcript}),v.type==="model-output"){console.log("Model output detected - Full message:",v);const D=v.content||v.text||v.transcript||v.output;if(D){console.log("Adding model output to conversation:",D);const F={callId:d?.id||`call-${Date.now()}`,role:"assistant",content:D,timestamp:new Date,isModelOutput:!0,tenantId:O||"default"};console.log("Adding new transcript for model output:",F),t(le=>{const ge=[...le,F];return console.log("Updated transcripts array:",ge),ge}),x(F)}else console.warn("Model output message received but no content found:",v)}if(v.type==="transcript"){console.log("Adding transcript:",v);const D={callId:d?.id||`call-${Date.now()}`,role:v.role,content:v.content||v.transcript||"",timestamp:new Date,tenantId:O||"default"};t(F=>[...F,D]),x(D)}};w.on("message",v=>{try{W(v)}catch(D){console.warn("Error handling Vapi message:",D)}}),w.on("call-end",()=>{console.log("📞 [AssistantContext] Vapi call-end event received"),console.log("📊 [AssistantContext] Call-end context:",{transcriptsCount:n.length,hasCallSummary:!!f,hasServiceRequests:C?.length>0,callDuration:S,isEndingCall:V});try{setTimeout(()=>{console.log("🔔 [AssistantContext] Triggering call end listeners..."),se.forEach(v=>{try{v()}catch(D){console.error("❌ [AssistantContext] Error in call end listener:",D)}}),console.log("✅ [AssistantContext] Call end listeners triggered successfully")},1e3)}catch(v){console.error("❌ [AssistantContext] Error triggering call end listeners:",v)}})}catch(y){console.error("Error setting up Vapi:",y)}})(),()=>{q.current=!1;const y=$();y&&(console.log("🧹 [setupVapi] Cleanup: Stopping Vapi due to dependency change"),y.stop())}},[T,N,O,V]),e.useEffect(()=>(q.current=!0,()=>{q.current=!1}),[]);const _e=()=>{const u=$();u&&(u.setMuted(!a),h(!a))},Le=G.useCallback(async()=>{try{U(!1);const u=`call-${Date.now()}`;g({id:u,roomNumber:"",duration:"",category:"",language:T}),t([]),ae([]);const y=$();if(!y)throw console.error("❌ [startCall] Vapi instance not initialized"),new Error("Voice assistant not initialized. Please refresh the page and try again.");const w=N?await ot(T,N):void 0;if(console.log("🤖 [startCall] Selected assistantId for language",T,":",w?w.substring(0,10)+"...":"undefined"),!w)throw console.error("❌ [startCall] Assistant ID not configured for language:",T),new Error(`Voice assistant not configured for ${T}. Please contact support.`);console.log("🚀 [startCall] Starting Vapi call...");const I=await y.start(w);if(!I)throw console.error("❌ [startCall] Vapi.start() returned null/undefined"),new Error("Failed to start voice call. Please check your internet connection and try again.");console.log("✅ [startCall] Call started successfully:",I),p(0);const b=setInterval(()=>{p(x=>x+1)},1e3);s(b)}catch(u){console.error("❌ [startCall] Error starting call:",u);const y=u instanceof Error?u.message:"Unknown error occurred";console.error("❌ [startCall] Detailed error:",{error:u,language:T,hasHotelConfig:!!N,vapiInstance:!!$()}),typeof window<"u"&&alert(`Failed to start voice call: ${y}`),p(0),r&&(clearInterval(r),s(null))}},[T,N,O]),Ne=e.useCallback(()=>{console.log("🛑 [AssistantContext] endCall() called"),console.log("🔍 [AssistantContext] Current state before endCall:",{callDuration:S,transcriptsCount:n.length,hasCallDetails:!!d,hasCallTimer:!!r,language:T,tenantId:O,isEndingCall:V}),console.log("🚫 [AssistantContext] Step 0: Setting isEndingCall flag to prevent Vapi reinitialization..."),Y(!0);try{console.log("🔄 [AssistantContext] Step 1: Stopping VAPI IMMEDIATELY...");try{const u=$();u?(console.log("📞 [AssistantContext] Step 1a: VAPI instance found, calling stop()..."),u.stop(),typeof u.cleanup=="function"&&(console.log("🧹 [AssistantContext] Step 1b: Calling vapi.cleanup()..."),u.cleanup()),typeof u.disconnect=="function"&&(console.log("🔌 [AssistantContext] Step 1c: Calling vapi.disconnect()..."),u.disconnect()),console.log("✅ [AssistantContext] Step 1: VAPI fully stopped and cleaned up")):console.log("⚠️ [AssistantContext] Step 1a: No VAPI instance to stop")}catch(u){console.error("❌ [AssistantContext] Step 1 ERROR: Error stopping VAPI:",u),console.log("🔄 [AssistantContext] Continuing with cleanup despite VAPI error...")}console.log("🔄 [AssistantContext] Step 2: Batch state updates...");try{console.log("🔄 [AssistantContext] Step 2a: Formatting call duration...");const u=S?`${Math.floor(S/60)}:${(S%60).toString().padStart(2,"0")}`:"0:00";console.log("✅ [AssistantContext] Step 2a: Duration formatted:",u),console.log("🔄 [AssistantContext] Step 2b: Updating states..."),(()=>{console.log("🔄 [AssistantContext] Step 2b-1: Stopping timer..."),r?(clearInterval(r),s(null),console.log("✅ [AssistantContext] Timer stopped and cleared")):console.log("⚠️ [AssistantContext] No timer to stop"),console.log("🔄 [AssistantContext] Step 2b-2: Setting initial order summary..."),c(st),console.log("✅ [AssistantContext] Step 2b: State cleanup completed")})(),console.log("🔄 [AssistantContext] Step 3: Processing summary generation...");try{const w=n.map(I=>({role:I.role,content:I.content}));if(console.log("🔍 [AssistantContext] Transcript data prepared:",{count:w.length,firstFew:w.slice(0,2)}),w.length>=2){console.log("📝 [AssistantContext] Step 3a: Sufficient transcript data, processing call summary...");const I={callId:d?.id||`call-${Date.now()}`,content:"Generating AI summary of your conversation...",timestamp:new Date,tenantId:O||"default"};E(I),console.log("✅ [AssistantContext] Loading summary state set"),console.log("🔄 [AssistantContext] Step 3b: Sending transcript data to server for OpenAI processing..."),fetch("/api/store-summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({summary:"",transcripts:w,timestamp:new Date().toISOString(),callId:d?.id||`call-${Date.now()}`,callDuration:u,forceBasicSummary:!1,language:T,tenantId:O||"default"})}).then(b=>{if(console.log("📡 [AssistantContext] Store-summary API response received:",b.status),!b.ok)throw new Error(`Network response was not ok: ${b.status}`);return b.json()}).then(b=>{if(console.log("✅ [AssistantContext] Store-summary API data received:",b),b.success&&b.summary&&b.summary.content){console.log("📋 [AssistantContext] Valid summary received, updating state...");const x=b.summary.content,W={callId:d?.id||`call-${Date.now()}`,content:x,timestamp:new Date(b.summary.timestamp||Date.now()),tenantId:O||"default"};E(W),console.log("✅ [AssistantContext] Summary state updated successfully"),b.serviceRequests&&Array.isArray(b.serviceRequests)&&b.serviceRequests.length>0?(console.log("📝 [AssistantContext] Service requests received:",b.serviceRequests.length),A(b.serviceRequests)):console.log("⚠️ [AssistantContext] No service requests in response")}else console.log("⚠️ [AssistantContext] Invalid summary data received:",b)}).catch(b=>{console.error("❌ [AssistantContext] Error processing summary:",b);const x={callId:d?.id||`call-${Date.now()}`,content:"An error occurred while generating the call summary.",timestamp:new Date,tenantId:O||"default"};E(x),console.log("✅ [AssistantContext] Error summary state set")})}else{console.log("⚠️ [AssistantContext] Step 3a: Not enough transcript data for summary"),console.log("🔍 [AssistantContext] Transcript data count:",w.length);const I={callId:d?.id||`call-${Date.now()}`,content:"Call was too short to generate a summary. Please try a more detailed conversation.",timestamp:new Date,tenantId:O||"default"};E(I),console.log("✅ [AssistantContext] No transcript summary state set")}}catch(w){console.error("❌ [AssistantContext] Step 3 ERROR: Error in summary processing:",w)}}catch(u){console.error("❌ [AssistantContext] Step 2 ERROR: Error during state cleanup:",u),console.log("🔄 [AssistantContext] Attempting force cleanup of critical states...");try{r&&(clearInterval(r),s(null),console.log("✅ [AssistantContext] Force timer cleanup completed"))}catch(y){console.error("❌ [AssistantContext] Failed to clear timer:",y)}}console.log("✅ [AssistantContext] endCall() completed successfully")}catch(u){console.error("❌ [AssistantContext] CRITICAL ERROR in endCall():",u),console.error("❌ [AssistantContext] Error name:",u.name),console.error("❌ [AssistantContext] Error message:",u.message),console.error("❌ [AssistantContext] Error stack:",u.stack),console.log("🔄 [AssistantContext] Attempting emergency cleanup...");try{r&&(clearInterval(r),s(null),console.log("✅ [AssistantContext] Emergency timer cleanup completed"))}catch(y){console.error("🚨 [AssistantContext] Emergency cleanup failed:",y)}console.log("🔄 [AssistantContext] endCall() error handled gracefully, continuing normal operation")}finally{setTimeout(()=>{console.log("🔄 [AssistantContext] Resetting isEndingCall flag..."),Y(!1)},2e3)}},[r,S,n,d?.id,O,T,V]),Fe=async u=>{try{console.log("Requesting Vietnamese translation for summary...");const y=await fetch("/api/translate-to-vietnamese",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:u})});if(!y.ok)throw new Error(`Network response was not ok: ${y.status}`);const w=await y.json();if(w.success&&w.translatedText)return R(w.translatedText),w.translatedText;throw new Error("Translation failed")}catch(y){return console.error("Error translating to Vietnamese:",y),"Không thể dịch nội dung này sang tiếng Việt. Vui lòng thử lại sau."}},Me=u=>{ae(y=>[...y,u])};e.useEffect(()=>{let u=null;const y=async()=>{try{const{authenticatedFetch:w}=await j(async()=>{const{authenticatedFetch:x}=await import("./services-DrymXMI4.js").then(W=>W.h);return{authenticatedFetch:x}},__vite__mapDeps([0,1,2,3,4,5,6])),I=await w("/api/request");if(!I.ok){(I.status===401||I.status===403)&&console.warn("⚠️ [AssistantContext] Auth failed - token may be invalid or missing");return}const b=await I.json();console.log("[AssistantContext] Fetched orders from API:",b),Array.isArray(b)&&H(b.map(x=>({reference:x.specialInstructions||x.reference||x.callId||"",requestedAt:x.createdAt?new Date(x.createdAt):new Date,estimatedTime:x.deliveryTime||"",status:x.status==="completed"?"Hoàn thiện":x.status==="pending"?"Đã ghi nhận":x.status,...x})))}catch{}};return y(),u=setInterval(y,5e3),()=>{u&&clearInterval(u)}},[]);const He={transcripts:n,setTranscripts:t,addTranscript:Oe,orderSummary:i,setOrderSummary:c,callDetails:d,setCallDetails:g,order:l,setOrder:De,callDuration:S,setCallDuration:p,isMuted:a,toggleMute:_e,startCall:Le,endCall:Ne,callSummary:f,setCallSummary:E,serviceRequests:C,setServiceRequests:A,vietnameseSummary:P,setVietnameseSummary:R,translateToVietnamese:Fe,emailSentForCurrentSession:M,setEmailSentForCurrentSession:U,requestReceivedAt:K,setRequestReceivedAt:oe,activeOrders:k,addActiveOrder:Pe,setActiveOrders:H,micLevel:me,modelOutput:pe,setModelOutput:ae,addModelOutput:Me,language:T,setLanguage:ke,hotelConfig:N,setHotelConfig:Ie,tenantId:O,setTenantId:xe,tenantConfig:fe,setTenantConfig:Re,addCallEndListener:re};return L.jsx(be.Provider,{value:He,children:o})}function ne(){const o=e.useContext(be);return o===void 0?(console.warn("useAssistant used outside AssistantProvider - returning safe defaults"),{transcripts:[],setTranscripts:()=>{},addTranscript:()=>{},orderSummary:null,setOrderSummary:()=>{},callDetails:null,setCallDetails:()=>{},order:null,setOrder:()=>{},callDuration:0,setCallDuration:()=>{},isMuted:!1,toggleMute:()=>{},startCall:async()=>{},endCall:()=>{},callSummary:null,setCallSummary:()=>{},serviceRequests:[],setServiceRequests:()=>{},vietnameseSummary:null,setVietnameseSummary:()=>{},translateToVietnamese:async()=>"",emailSentForCurrentSession:!1,setEmailSentForCurrentSession:()=>{},requestReceivedAt:null,setRequestReceivedAt:()=>{},activeOrders:[],addActiveOrder:()=>{},setActiveOrders:()=>{},micLevel:0,modelOutput:[],setModelOutput:()=>{},addModelOutput:()=>{},language:"en",setLanguage:()=>{},hotelConfig:null,setHotelConfig:()=>{},tenantId:null,setTenantId:()=>{},tenantConfig:null,setTenantConfig:()=>{},addCallEndListener:()=>()=>{}}):o}const rt=({isActive:o})=>{const[n,t]=e.useState(!1),i=e.useRef(null),c=e.useRef(null),d=e.useRef(null),g=e.useRef(null),l=(p,r)=>{let s,a=0;return(...h)=>{const f=Date.now();f-a>r?(p(...h),a=f):(clearTimeout(s),s=setTimeout(()=>{p(...h),a=Date.now()},r-(f-a)))}};return e.useEffect(()=>{const r=l(()=>{const s=window.scrollY;t(s>Z.SCROLL_THRESHOLD);const a=i.current,h=c.current;if(a&&h){a.getBoundingClientRect();const f=h.getBoundingClientRect();f.top<window.innerHeight&&f.bottom>0&&(f.top<0||f.bottom>window.innerHeight)&&f.top<Z.SCROLL_OFFSETS.NEGATIVE_TOP_THRESHOLD&&h.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}},Z.THROTTLE_DELAY);return window.addEventListener("scroll",r),()=>window.removeEventListener("scroll",r)},[]),e.useEffect(()=>{o||window.scrollTo({top:0,behavior:"smooth"})},[o]),{showScrollButton:n,scrollToTop:()=>{window.scrollTo({top:0,behavior:"smooth"})},scrollToSection:p=>{const s={hero:i,services:c,conversation:d}[p];s.current&&s.current.scrollIntoView({behavior:"smooth",block:p==="hero"?"start":"center",inline:"nearest"})},heroSectionRef:i,serviceGridRef:c,conversationRef:d,rightPanelRef:g}},at=({conversationRef:o})=>{const{startCall:n,endCall:t,callDuration:i,transcripts:c,setLanguage:d}=ne(),[g,l]=e.useState(!1),[m,S]=e.useState(!1),[p,r]=e.useState(!1);e.useEffect(()=>{const f=i>0;console.log("🔄 [useConversationState] Syncing call states:",{callDuration:i,isActive:f,isCallStarted:g,manualCallStarted:p,transcriptsCount:c.length}),f&&!g&&!p?(console.log("✅ [useConversationState] Active call detected - syncing isCallStarted = true"),l(!0)):!f&&g&&!p?(console.log("❌ [useConversationState] Call ended - syncing isCallStarted = false"),l(!1)):p?console.log("⏳ [useConversationState] Manual call start in progress - keeping isCallStarted = true"):(console.log("❌ [useConversationState] No active call and no manual start - syncing isCallStarted = false"),l(!1))},[i,g,p]),e.useEffect(()=>{const f=i>0,E=f||c.length>0||p;console.log("🔄 [useConversationState] Evaluating showConversation:",{isActive:f,transcriptsCount:c.length,manualCallStarted:p,currentShowConversation:m,shouldShowConversation:E}),m!==E?(console.log(`🔄 [useConversationState] Updating showConversation: ${m} → ${E}`),S(E)):console.log("✅ [useConversationState] showConversation unchanged - no re-render")},[c.length,p,i]),e.useEffect(()=>{m&&o.current&&setTimeout(()=>{o.current?.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})},Z.AUTO_SCROLL_DELAY)},[m,o]);const s=e.useCallback(async f=>{console.log("🎤 [useConversationState] Starting call with language:",f),console.log("🎤 [useConversationState] Current state before call:",{isCallStarted:g,manualCallStarted:p,callDuration:i,transcriptsCount:c.length});const E=!1;console.log("🔍 [useConversationState] Environment check:",{isDevelopment:!1,forceVapiInDev:E,hasVapiCredentials:!1,publicKey:"MISSING",assistantId:"MISSING",publicKey_VI:"MISSING",assistantId_VI:"MISSING"});const C=void 0;console.log("🔍 [useConversationState] hasAnyVapiCredentials:",!1);const A=!1;try{return console.log("🚀 [PRODUCTION MODE] Using real VAPI call start"),l(!0),r(!0),await n(),console.log("✅ [useConversationState] Real call started successfully"),{success:!0}}catch(P){console.error("❌ [useConversationState] Error starting call:",P),l(!1),r(!1);const R=P instanceof Error?P.message:"Unknown error occurred";return R.includes("webCallUrl")?{success:!1,error:"Voice call initialization failed. Please check your internet connection and try again."}:R.includes("assistant")?{success:!1,error:"Voice assistant configuration issue. Please contact support."}:R.includes("network")||R.includes("fetch")?{success:!1,error:"Network error. Please check your internet connection and try again."}:R.includes("permissions")||R.includes("microphone")?{success:!1,error:"Microphone access required. Please enable microphone permissions and try again."}:{success:!1,error:`Failed to start voice call: ${R}`}}},[g,p,i,c,n,d]),a=e.useCallback(()=>{console.log("🛑 [useConversationState] Ending call"),console.log("🔍 [useConversationState] Current isCallStarted state:",g),console.log("📞 [useConversationState] Step 1: Calling endCall() to stop VAPI...");try{t(),console.log("✅ [useConversationState] endCall() completed - VAPI stopped")}catch(f){console.error("❌ [useConversationState] Error in endCall():",f)}console.log("📞 [useConversationState] Step 2: Updating UI state..."),l(!1),r(!1),console.log("✅ [useConversationState] UI state updated"),console.log("🔍 [useConversationState] Step 3: Checking development mode..."),console.log("🚀 [PRODUCTION MODE] Real call end completed"),console.log("📝 [useConversationState] Staying in Interface1 - No interface switching")},[t,g]),h=e.useCallback(()=>{console.log("❌ [useConversationState] Canceling call - FULL RESET");try{l(!1),S(!1),r(!1);try{t(),console.log("✅ [useConversationState] endCall() executed successfully")}catch(f){console.error("⚠️ [useConversationState] endCall() failed but continuing with cancel:",f)}console.log("✅ [useConversationState] Cancel completed - all states reset"),console.log("📊 [useConversationState] Final state: isCallStarted=false, showConversation=false")}catch(f){console.error("❌ [useConversationState] Error in handleCancel:",f),l(!1),S(!1),r(!1),console.log("🔄 [useConversationState] Forced state reset after error")}},[t]);return{isCallStarted:g,showConversation:m,handleCallStart:s,handleCallEnd:a,handleCancel:h}},lt=({conversationState:o,conversationPopupId:n,setConversationPopupId:t,setShowRightPanel:i,transcripts:c})=>{const{removePopup:d}=de();return{handleCancel:e.useCallback(()=>{console.log("❌ [useCancelHandler] Cancel button clicked - Returning to Interface1 initial state"),console.log("📊 [useCancelHandler] Current state:",{isCallStarted:o.isCallStarted,conversationPopupId:n,transcriptsCount:c.length});try{if(n)try{console.log("🗑️ [useCancelHandler] Removing conversation popup:",n),d(n),t(null),console.log("✅ [useCancelHandler] Popup removed successfully")}catch(l){console.error("⚠️ [useCancelHandler] Failed to remove popup but continuing:",l),t(null)}try{o.handleCancel(),console.log("✅ [useCancelHandler] conversationState.handleCancel() completed")}catch(l){console.error("⚠️ [useCancelHandler] conversationState.handleCancel() failed:",l)}try{i(!1),console.log("✅ [useCancelHandler] Right panel closed")}catch(l){console.error("⚠️ [useCancelHandler] Failed to close right panel:",l)}try{window.scrollTo({top:0,behavior:"smooth"}),console.log("✅ [useCancelHandler] Scrolled to top")}catch(l){console.error("⚠️ [useCancelHandler] Failed to scroll to top:",l)}console.log("✅ [useCancelHandler] Cancel completed - Interface1 returned to initial state")}catch(l){console.error("❌ [useCancelHandler] Critical error in handleCancel:",l);try{n&&(d(n),t(null)),i(!1),window.scrollTo({top:0,behavior:"auto"}),console.log("🚨 [useCancelHandler] Emergency cleanup completed")}catch(m){console.error("🚨 [useCancelHandler] Emergency cleanup failed:",m)}console.log("🔄 [useCancelHandler] Cancel operation completed despite errors - UI restored")}},[o,n,d,c.length,i,t])}},it=({endCall:o,transcripts:n,callSummary:t,serviceRequests:i})=>{const{showSummary:c}=de(),d=e.useRef(null),g=e.useRef(!1),l=e.useRef(!0),m=e.useCallback(()=>{console.log("✅ [useConfirmHandler] Confirm button clicked in SiriButtonContainer"),console.log("📊 [useConfirmHandler] Current state:",{transcriptsCount:n.length,hasCallSummary:!!t,hasServiceRequests:i?.length>0});const p=async()=>{try{if(console.log("📋 [useConfirmHandler] Step 1: Showing immediate loading popup..."),!l.current){console.warn("⚠️ [useConfirmHandler] Component unmounted, aborting");return}try{const r=e.createElement("div",{id:"summary-loading-popup",style:{padding:"20px",textAlign:"center",maxWidth:"400px"}},[e.createElement("h3",{key:"title",style:{marginBottom:"16px",color:"#333",fontSize:"18px",fontWeight:"600"}},"📋 Call Summary"),e.createElement("div",{key:"loading",style:{marginBottom:"16px"}},[e.createElement("div",{key:"spinner",style:{display:"inline-block",width:"24px",height:"24px",border:"3px solid #f3f3f3",borderTop:"3px solid #3498db",borderRadius:"50%",animation:"spin 1s linear infinite",marginRight:"12px"}}),e.createElement("span",{key:"text",style:{fontSize:"16px",color:"#555",fontWeight:"500"}},"Processing call...")]),e.createElement("p",{key:"message",style:{fontSize:"14px",color:"#666",lineHeight:"1.5",marginBottom:"16px"}},"Please wait while we finalize your conversation."),e.createElement("div",{key:"time",style:{fontSize:"12px",color:"#999",marginTop:"12px"}},"Call ended at: "+new Date().toLocaleTimeString())]);if(!document.getElementById("spinner-animation"))try{const s=document.createElement("style");s.id="spinner-animation",s.textContent=`
                @keyframes spin {
                  0% { transform: rotate(0deg); }
                  100% { transform: rotate(360deg); }
                }
              `,document.head.appendChild(s)}catch(s){console.warn("⚠️ [useConfirmHandler] Failed to add spinner styles:",s)}console.log("🚀 [useConfirmHandler] Step 1b: Calling showSummary..."),c(r,{title:"Processing Call...",priority:"high"}),console.log("✅ [useConfirmHandler] Step 1c: Loading popup shown successfully")}catch(r){console.error("❌ [useConfirmHandler] Step 1 ERROR: Loading popup creation failed:",r)}if(console.log("⏳ [useConfirmHandler] Step 1.5: Brief delay before ending call..."),await new Promise(r=>setTimeout(r,300)),!l.current){console.warn("⚠️ [useConfirmHandler] Component unmounted during delay, aborting");return}console.log("🔄 [useConfirmHandler] Step 2: Ending call immediately...");try{if(l.current){console.log("📞 [useConfirmHandler] Step 2a: Calling endCall() immediately..."),o(),console.log("✅ [useConfirmHandler] Step 2a: Call ended successfully");try{const{getVapiInstance:r}=await j(async()=>{const{getVapiInstance:a}=await import("./services-DrymXMI4.js").then(h=>h.f);return{getVapiInstance:a}},__vite__mapDeps([0,1,2,3,4,5,6])),s=r();s?(console.log("🔧 [useConfirmHandler] Step 2b: Force stopping Vapi instance as backup..."),s.stop(),console.log("✅ [useConfirmHandler] Step 2b: Vapi instance force stopped")):console.log("⚠️ [useConfirmHandler] Step 2b: No Vapi instance found to force stop")}catch(r){console.warn("⚠️ [useConfirmHandler] Step 2b: Backup Vapi stop failed:",r)}}}catch(r){console.error("⚠️ [useConfirmHandler] endCall() failed:",r)}console.log("🔄 [useConfirmHandler] Step 3: Showing completion message..."),setTimeout(()=>{if(l.current)try{const r=e.createElement("div",{style:{padding:"20px",textAlign:"center",maxWidth:"400px"}},[e.createElement("h3",{key:"title",style:{marginBottom:"16px",color:"#333",fontSize:"18px",fontWeight:"600"}},"📋 Call Complete"),e.createElement("div",{key:"icon",style:{fontSize:"48px",marginBottom:"16px"}},"✅"),e.createElement("p",{key:"message",style:{marginBottom:"16px",lineHeight:"1.5",color:"#333",fontSize:"16px"}},"Your call has been completed successfully!"),n.length>0&&e.createElement("div",{key:"transcript-info",style:{marginBottom:"16px",padding:"12px",backgroundColor:"#f0f9ff",borderRadius:"6px",fontSize:"14px"}},[e.createElement("div",{key:"transcript-title",style:{fontWeight:"600",marginBottom:"4px",color:"#1e40af"}},"Conversation Summary:"),e.createElement("div",{key:"transcript-count",style:{color:"#374151"}},`${n.length} messages recorded`)]),i?.length>0&&e.createElement("div",{key:"requests",style:{marginBottom:"16px",padding:"12px",backgroundColor:"#f0fdf4",borderRadius:"6px",fontSize:"14px"}},[e.createElement("div",{key:"req-title",style:{fontWeight:"600",marginBottom:"8px",color:"#15803d"}},"Service Requests:"),e.createElement("ul",{key:"req-list",style:{listStyle:"disc",marginLeft:"20px",color:"#374151"}},i.slice(0,3).map((s,a)=>e.createElement("li",{key:a,style:{marginBottom:"4px"}},`${s.serviceType||"Request"}: ${(s.requestText||s.description||"Service request").substring(0,50)}...`)))]),e.createElement("p",{key:"note",style:{fontSize:"14px",color:"#666",marginBottom:"16px"}},"Thank you for using our voice assistant service."),e.createElement("div",{key:"contact",style:{fontSize:"12px",color:"#999",borderTop:"1px solid #eee",paddingTop:"12px",marginTop:"16px"}},"For immediate assistance, please contact the front desk.")]);c(r,{title:"Call Complete",priority:"high"}),console.log("✅ [useConfirmHandler] Completion message shown successfully")}catch(r){console.error("❌ [useConfirmHandler] Error showing completion message:",r),l.current&&setTimeout(()=>alert("Call completed successfully! Thank you for using our service."),100)}},1e3),console.log("✅ [useConfirmHandler] Confirm flow completed successfully")}catch(r){if(console.error("❌ [useConfirmHandler] CRITICAL ERROR in handleConfirm:",r),l.current)try{const s=e.createElement("div",{style:{padding:"20px",textAlign:"center",maxWidth:"400px"}},[e.createElement("h3",{key:"title",style:{marginBottom:"16px",color:"#dc2626",fontSize:"18px",fontWeight:"600"}},"⚠️ Call Processing Issue"),e.createElement("p",{key:"message",style:{marginBottom:"16px",color:"#374151",fontSize:"16px"}},"Your call was completed, but there was an issue processing the summary."),e.createElement("p",{key:"instruction",style:{fontSize:"14px",color:"#666",marginBottom:"16px"}},"Please contact the front desk if you need assistance with your requests."),e.createElement("div",{key:"timestamp",style:{fontSize:"12px",color:"#999",marginTop:"12px"}},"Call ended at: "+new Date().toLocaleTimeString())]);c(s,{title:"Call Complete (with issue)",priority:"medium"})}catch(s){console.error("❌ [useConfirmHandler] Fallback popup also failed:",s),setTimeout(()=>{l.current&&alert("Call completed! There was a technical issue with the summary. Please contact front desk for assistance.")},500)}}};try{p()}catch(r){console.error("❌ [useConfirmHandler] OUTER ERROR BOUNDARY:",r),setTimeout(()=>{l.current&&alert("Call completed! Technical issue occurred. Please contact front desk.")},100)}},[o,n,t,i,c]),S=e.useCallback(()=>{l.current=!1,g.current=!1,d.current&&(clearInterval(d.current),d.current=null)},[]);return G.useEffect(()=>(l.current=!0,S),[S]),{handleConfirm:m}},At=({isActive:o})=>{const{micLevel:n,transcripts:t,callSummary:i,serviceRequests:c,language:d,endCall:g,addCallEndListener:l}=ne(),{config:m,isLoading:S,error:p}=ve(),{showNotification:r,showSummary:s}=de(),[a,h]=e.useState(null),f=rt({isActive:o}),E=at({conversationRef:f.conversationRef}),[C,A]=e.useState(!1),P=e.useRef(!0),{handleCancel:R}=lt({conversationState:E,conversationPopupId:a,setConversationPopupId:h,setShowRightPanel:A,transcripts:t}),{handleConfirm:M}=it({endCall:g,transcripts:t,callSummary:i,serviceRequests:c}),{popups:U}=Qe(),[K,oe]=e.useState(!1);e.useEffect(()=>{const k=U.find(H=>H.type==="summary");oe(!!k)},[U]);const V=e.useCallback(()=>{console.log("🔮 [useInterface1] Auto-showing Summary Popup after call end...");try{s(void 0,{title:"Call Summary",priority:"high"}),console.log("✅ [useInterface1] Summary Popup auto-shown successfully")}catch(k){console.error("❌ [useInterface1] Error auto-showing summary popup:",k),setTimeout(()=>{alert("Call completed! Please check your conversation summary.")},500)}},[s]);e.useEffect(()=>{console.log("📞 [useInterface1] Registering auto-summary listener...");const k=l(V);return console.log("✅ [useInterface1] Auto-summary listener registered"),()=>{console.log("🧹 [useInterface1] Unregistering auto-summary listener..."),k()}},[l,V]),e.useEffect(()=>{if(P.current){P.current=!1;return}},[]),e.useEffect(()=>{console.log("🚫 [useInterface1] Language change restart logic temporarily disabled for debugging")},[d,E.isCallStarted,a,E.handleCallEnd,E.handleCallStart]);const Y=e.useCallback(()=>{A(k=>!k)},[]),q=e.useCallback(()=>{A(!1)},[]),se=e.useCallback(()=>{console.log("Conversation demo disabled - using unified ChatPopup instead")},[]),J=e.useCallback(()=>{j(()=>import("./components-BqWspkJD.js").then(k=>k.aa),__vite__mapDeps([7,3,2,1,5,6,4,0,8,9,10,11])).then(k=>{const{NotificationDemoContent:H}=k;r(e.createElement(H),{title:"Pool Maintenance",priority:"medium",badge:1})}).catch(()=>{r(e.createElement("div",{style:{padding:"16px"}},[e.createElement("h4",{key:"title"},"Hotel Notification"),e.createElement("p",{key:"content"},"Pool maintenance from 2-4 PM today.")]),{title:"Pool Maintenance",priority:"medium",badge:1})})},[r]),re=e.useCallback(()=>{j(()=>import("./components-BqWspkJD.js").then(k=>k.aa),__vite__mapDeps([7,3,2,1,5,6,4,0,8,9,10,11])).then(k=>{const{SummaryPopupContent:H}=k;s(e.createElement(H),{title:"Call Summary",priority:"high"})}).catch(()=>{s(e.createElement("div",{style:{padding:"16px",fontSize:"12px"}},[e.createElement("div",{key:"title",style:{fontWeight:"bold",marginBottom:"8px"}},"📋 Call Summary"),e.createElement("div",{key:"room"},"Room: 101"),e.createElement("div",{key:"items"},"Items: 3 requests"),e.createElement("div",{key:"time",style:{fontSize:"10px",color:"#666",marginTop:"8px"}},"Generated at "+new Date().toLocaleTimeString())]),{title:"Call Summary",priority:"high"})})},[s]);return e.useEffect(()=>{a&&t.length>0&&console.log(`📊 [useInterface1] Transcripts updated: ${t.length} messages`)},[t.length,a]),{isLoading:S||!m,error:p,hotelConfig:m,micLevel:n,...f,isCallStarted:E.isCallStarted,showConversation:E.showConversation,handleCallStart:E.handleCallStart,handleCallEnd:E.handleCallEnd,handleCancel:R,handleConfirm:M,showingSummary:K,showRightPanel:C,handleRightPanelToggle:Y,handleRightPanelClose:q,handleShowConversationPopup:se,handleShowNotificationDemo:J,handleShowSummaryDemo:re}},_={ORDER_TYPE_DEFAULT:"Room Service",DELIVERY_TIME_DEFAULT:"asap",SERVICE_NAME_DEFAULT:"General Service",ROOM_NUMBER_FALLBACK:"unknown",ORDER_PREFIX:"ORD",ORDER_MIN:1e4,ORDER_RANGE:9e4,STATUS_PENDING:"pending"},B={NO_ORDER_DATA:"No order information available to send!",REQUEST_FAILED:"Failed to send request to Front Desk!",NETWORK_ERROR:"Network error occurred while sending request",SERVER_ERROR:"Server error occurred while processing request"},ct={REQUEST_SENT:"✅ Request sent to Front Desk successfully!"},Tt=({onSuccess:o,onError:n}={})=>{const{callSummary:t,serviceRequests:i,orderSummary:c,setOrder:d}=ne(),[g,l]=e.useState(!1),m=e.useMemo(()=>({id:"1",name:_.SERVICE_NAME_DEFAULT,description:"Service request from voice call",quantity:1,price:0}),[]),S=e.useMemo(()=>c||(!t&&(!i||i.length===0)?null:{orderType:_.ORDER_TYPE_DEFAULT,deliveryTime:_.DELIVERY_TIME_DEFAULT,roomNumber:"",guestName:"",guestEmail:"",guestPhone:"",specialInstructions:"",items:i?.map((C,A)=>({id:(A+1).toString(),name:C.serviceType||_.SERVICE_NAME_DEFAULT,description:C.requestText||"No details provided",quantity:1,price:0}))||[m],totalAmount:0}),[c,t,i,m]),p=e.useCallback((C,A)=>{if(C?.roomNumber&&C.roomNumber!==_.ROOM_NUMBER_FALLBACK)return C.roomNumber;if(A){const P=/Room Number:?\s*(\w+)/i,R=A.match(P);if(R&&R[1])return R[1]}return _.ROOM_NUMBER_FALLBACK},[]),r=e.useCallback(()=>{const C=Math.floor(_.ORDER_MIN+Math.random()*_.ORDER_RANGE);return`${_.ORDER_PREFIX}-${C}`},[]),s=e.useCallback(C=>{const A=r(),P=C.items&&C.items.length>0?C.items:[m];return{callId:A,roomNumber:p(C,t?.content),orderType:C.orderType||_.ORDER_TYPE_DEFAULT,deliveryTime:C.deliveryTime||_.DELIVERY_TIME_DEFAULT,specialInstructions:A,items:P,totalAmount:C.totalAmount||0,status:_.STATUS_PENDING,createdAt:new Date().toISOString()}},[p,r,m,t?.content]),a=e.useCallback(async C=>{console.log("📤 [useSendToFrontDeskHandler] Submitting request to /api/request:",C);const{authenticatedFetch:A}=await j(async()=>{const{authenticatedFetch:M}=await import("./services-DrymXMI4.js").then(U=>U.h);return{authenticatedFetch:M}},__vite__mapDeps([0,1,2,3,4,5,6]));console.log("🔐 [useSendToFrontDeskHandler] Using authenticated fetch with auto-retry");const P=await A("/api/request",{method:"POST",body:JSON.stringify(C)});if(!P.ok){const M=P.status;throw M>=500?new Error(B.SERVER_ERROR):M>=400?new Error(B.REQUEST_FAILED):new Error(B.NETWORK_ERROR)}const R=await P.json();if(!R.success)throw new Error(R.error||B.REQUEST_FAILED);return R.data},[]),h=e.useCallback((C,A)=>{console.log("✅ [useSendToFrontDeskHandler] Request sent to Front Desk successfully"),d({reference:C.reference||C.orderId,estimatedTime:C.estimatedTime||A.deliveryTime||_.DELIVERY_TIME_DEFAULT,summary:A}),o?o():alert(ct.REQUEST_SENT)},[d,o]),f=e.useCallback(C=>{console.error("❌ [useSendToFrontDeskHandler] Failed to send request:",C);const A=C.message||B.REQUEST_FAILED;n?n(A):alert(`❌ ${A}`)},[n]);return{handleSendToFrontDesk:e.useCallback(async()=>{if(console.log("🏨 [useSendToFrontDeskHandler] Send to FrontDesk initiated"),!S){console.warn("⚠️ [useSendToFrontDeskHandler] No order summary available");const C=B.NO_ORDER_DATA;n?n(C):alert(C);return}l(!0);try{const C=s(S),A=await a(C);h(A,S)}catch(C){f(C)}finally{l(!1)}},[S,s,a,h,f,n]),isSubmitting:g}},It=()=>{const[o,n]=e.useState(()=>typeof window>"u"?!1:window.innerWidth>=768);return e.useEffect(()=>{const t=()=>{const i=window.innerWidth>=768;i!==o&&(n(i),console.log("🔄 [useSiriResponsiveSize] Platform changed:",i?"Desktop":"Mobile"))};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[o]),o?{width:"320px",height:"320px",minWidth:"320px",minHeight:"320px",maxWidth:"320px",maxHeight:"320px"}:{width:"min(300px, 80vw)",height:"min(300px, 80vw)",minWidth:"240px",minHeight:"240px",maxWidth:"300px",maxHeight:"300px"}},ue=768;function xt(){const[o,n]=e.useState(void 0);return e.useEffect(()=>{const t=window.matchMedia(`(max-width: ${ue-1}px)`),i=()=>{n(window.innerWidth<ue)};return t.addEventListener("change",i),n(window.innerWidth<ue),()=>t.removeEventListener("change",i)},[]),!!o}const ut=e.createContext(void 0);class Rt extends G.Component{constructor(n){super(n),this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,t){console.error("Hotel configuration error:",n,t)}render(){return this.state.hasError?this.props.fallback||L.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:L.jsxs("div",{className:"max-w-md w-full bg-white rounded-lg shadow-lg p-6 text-center",children:[L.jsx(Ve,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),L.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Configuration Error"}),L.jsx("p",{className:"text-gray-600 mb-4",children:"Failed to load hotel configuration. Please try refreshing the page."}),L.jsxs("button",{onClick:()=>window.location.reload(),className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md",children:[L.jsx(Ue,{className:"w-4 h-4 inline mr-2"}),"Reload Page"]})]})}):this.props.children}}const kt=({children:o})=>{console.log("[DEBUG] HotelProvider rendered");const n=ve(),{config:t,isLoading:i,error:c}=n,d=E=>"",g=E=>"",l=E=>t?.features?.[E]??!1,m=()=>t?.supportedLanguages||[],S=E=>t?.services||[],p=()=>({primary:t?.branding?.colors.primary||"#2E7D32",secondary:t?.branding?.colors.secondary||"#FFC107",accent:t?.branding?.colors.accent||"#FF6B6B"}),r=()=>({primary:t?.branding?.fonts.primary||"Inter",secondary:t?.branding?.fonts.secondary||"Roboto"}),s=()=>null,a=()=>null,h=()=>"UTC",f=()=>"USD";return L.jsx(ut.Provider,{value:{config:t,loading:i,error:c,reload:async()=>{},getVapiPublicKey:d,getVapiAssistantId:g,hasFeature:l,getSupportedLanguages:m,getAvailableServices:S,getThemeColors:p,getFontFamilies:r,getContactInfo:s,getLocation:a,getTimezone:h,getCurrency:f},children:o})};function Dt(){const[o,n]=e.useState(null),[t,i]=e.useState(!1),c=ne(),d=e.useRef(0),g=e.useCallback(()=>{console.log("useWebSocket env VITE_API_HOST:",void 0),o!==null&&o.close();const p=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`;console.log("Attempting WebSocket connection to",p);const r=new WebSocket(p);return r.onopen=()=>{console.log("WebSocket connection established"),i(!0),d.current=0,c.callDetails&&r.send(JSON.stringify({type:"init",callId:c.callDetails.id}))},r.onmessage=s=>{try{const a=JSON.parse(s.data);console.log("[useWebSocket] Message received:",a),a.type==="transcript"&&(console.log("[useWebSocket] Transcript message:",a),c.addTranscript({callId:a.callId,role:a.role,content:a.content,tenantId:"default"})),a.type==="connected"&&console.log("[useWebSocket] Connected to server:",a.message),a.type==="order_status_update"&&(a.orderId||a.reference)&&a.status&&(console.log("[useWebSocket] Order status update:",a),c.setActiveOrders(h=>h.map(f=>a.reference&&f.reference===a.reference||a.orderId&&f.reference===a.orderId?{...f,status:a.status}:f)))}catch(a){console.error("Error parsing WebSocket message:",a)}},r.onclose=s=>{if(console.log("WebSocket connection closed",s),i(!1),d.current<5){const a=Math.pow(2,d.current)*1e3;console.log(`Reconnecting WebSocket in ${a}ms (attempt ${d.current+1})`),setTimeout(g,a),d.current++}else console.warn("Max WebSocket reconnection attempts reached")},r.onerror=s=>{console.error("WebSocket encountered error",s),r.readyState!==WebSocket.CLOSED&&r.close()},n(r),()=>{r.close()}},[c.callDetails,c.addTranscript,c.activeOrders,c.setActiveOrders]),l=e.useCallback(S=>{o&&t?o.send(JSON.stringify(S)):console.error("Cannot send message, WebSocket not connected")},[o,t]),m=e.useCallback(()=>{t||g()},[t,g]);return e.useEffect(()=>(g(),()=>{o&&o.close()}),[]),e.useEffect(()=>{o&&t&&c.callDetails?.id&&(console.log("Sending init message with callId after availability",c.callDetails.id),o.send(JSON.stringify({type:"init",callId:c.callDetails.id})))},[c.callDetails?.id,o,t]),{connected:t,sendMessage:l,reconnect:m}}export{wt as A,kt as H,St as P,yt as S,j as _,ne as a,Qe as b,ht as c,Ct as d,Tt as e,At as f,vt as g,xt as h,Et as i,It as j,bt as k,Dt as l,tt as m,gt as u};
