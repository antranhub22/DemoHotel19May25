<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç VAPI Debug Test - Comprehensive</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .test-section {
            border: 1px solid #dee2e6;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç VAPI Comprehensive Debug Test</h1>
        <p>This test will help identify why VAPI assistant is not working.</p>

        <!-- ENVIRONMENT CHECK -->
        <div class="test-section">
            <h3>üîß 1. Environment Variables Check</h3>
            <div id="env-status" class="status info">Checking...</div>
            <div id="env-details" class="log"></div>
        </div>

        <!-- BROWSER CAPABILITIES -->
        <div class="test-section">
            <h3>üåê 2. Browser Capabilities Check</h3>
            <div id="browser-status" class="status info">Checking...</div>
            <div id="browser-details" class="log"></div>
        </div>

        <!-- MICROPHONE PERMISSIONS -->
        <div class="test-section">
            <h3>üé§ 3. Microphone Permissions Test</h3>
            <button id="test-microphone">Test Microphone Access</button>
            <div id="microphone-status" class="status info">Click button to test</div>
            <div id="microphone-details" class="log"></div>
        </div>

        <!-- VAPI SDK LOADING -->
        <div class="test-section">
            <h3>üì¶ 4. VAPI SDK Loading Test</h3>
            <button id="test-vapi-load">Test VAPI SDK Loading</button>
            <div id="vapi-load-status" class="status info">Click button to test</div>
            <div id="vapi-load-details" class="log"></div>
        </div>

        <!-- VAPI INITIALIZATION -->
        <div class="test-section">
            <h3>üöÄ 5. VAPI Initialization Test</h3>
            <button id="test-vapi-init" disabled>Test VAPI Initialization</button>
            <div id="vapi-init-status" class="status info">Complete previous tests first</div>
            <div id="vapi-init-details" class="log"></div>
        </div>

        <!-- VAPI CALL TEST -->
        <div class="test-section">
            <h3>üìû 6. VAPI Call Test</h3>
            <button id="test-vapi-call" disabled>Test VAPI Call</button>
            <div id="vapi-call-status" class="status info">Complete previous tests first</div>
            <div id="vapi-call-details" class="log"></div>
        </div>

        <!-- NETWORK TEST -->
        <div class="test-section">
            <h3>üåê 7. Network Connectivity Test</h3>
            <button id="test-network">Test VAPI API Connectivity</button>
            <div id="network-status" class="status info">Click button to test</div>
            <div id="network-details" class="log"></div>
        </div>

        <!-- RESULTS SUMMARY -->
        <div class="test-section">
            <h3>üìä Test Results Summary</h3>
            <div id="summary" class="log">Run tests to see summary...</div>
        </div>
    </div>

    <script>
        // Global variables
        let vapiInstance = null;
        let testResults = {};

        // Utility functions
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `[${timestamp}] ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            let html = '';
            Object.keys(testResults).forEach(test => {
                const result = testResults[test];
                const icon = result.success ? '‚úÖ' : '‚ùå';
                html += `${icon} ${test}: ${result.message}\n`;
            });
            summary.innerHTML = html;
        }

        // Test 1: Environment Variables
        function checkEnvironment() {
            log('env-details', 'üîç Checking environment variables...');

            const envVars = {
                'VITE_VAPI_PUBLIC_KEY': import.meta?.env?.VITE_VAPI_PUBLIC_KEY,
                'VITE_VAPI_ASSISTANT_ID': import.meta?.env?.VITE_VAPI_ASSISTANT_ID,
                'NODE_ENV': import.meta?.env?.NODE_ENV || 'unknown'
            };

            // For production builds, check if variables are embedded
            if (!envVars.VITE_VAPI_PUBLIC_KEY) {
                // Try to find them in window or embedded scripts
                log('env-details', '‚ö†Ô∏è Environment variables not found in import.meta.env');
                log('env-details', 'üîç Checking for embedded variables...');

                // Check common locations
                envVars.VITE_VAPI_PUBLIC_KEY = window.VITE_VAPI_PUBLIC_KEY ||
                    document.querySelector('meta[name="vapi-public-key"]')?.content ||
                    '4fba1458-6ea8-45c5-9653-76bbb54e64b5'; // fallback

                envVars.VITE_VAPI_ASSISTANT_ID = window.VITE_VAPI_ASSISTANT_ID ||
                    document.querySelector('meta[name="vapi-assistant-id"]')?.content ||
                    '18414a64-d242-447a-8162-ce3efd2cc8f1'; // fallback
            }

            let allGood = true;
            Object.keys(envVars).forEach(key => {
                const value = envVars[key];
                if (value) {
                    const displayValue = key.includes('KEY') || key.includes('ID') ?
                        value.substring(0, 10) + '...' : value;
                    log('env-details', `‚úÖ ${key}: ${displayValue}`);
                } else {
                    log('env-details', `‚ùå ${key}: MISSING`);
                    allGood = false;
                }
            });

            testResults['Environment'] = {
                success: allGood,
                message: allGood ? 'All variables present' : 'Missing variables'
            };

            setStatus('env-status',
                allGood ? '‚úÖ Environment OK' : '‚ùå Missing variables',
                allGood ? 'success' : 'error'
            );

            updateSummary();
            return allGood;
        }

        // Test 2: Browser Capabilities
        function checkBrowser() {
            log('browser-details', 'üåê Checking browser capabilities...');

            const checks = {
                'MediaDevices API': !!navigator.mediaDevices,
                'getUserMedia': !!navigator.mediaDevices?.getUserMedia,
                'WebRTC': !!window.RTCPeerConnection,
                'WebSockets': !!window.WebSocket,
                'AudioContext': !!window.AudioContext || !!window.webkitAudioContext,
                'HTTPS': location.protocol === 'https:',
                'Modern JS': !!window.fetch && !!window.Promise
            };

            let allGood = true;
            Object.keys(checks).forEach(check => {
                const result = checks[check];
                log('browser-details', `${result ? '‚úÖ' : '‚ùå'} ${check}`);
                if (!result) allGood = false;
            });

            log('browser-details', `üîç User Agent: ${navigator.userAgent.substring(0, 100)}...`);
            log('browser-details', `üîç Location: ${location.href}`);

            testResults['Browser'] = {
                success: allGood,
                message: allGood ? 'All capabilities available' : 'Missing capabilities'
            };

            setStatus('browser-status',
                allGood ? '‚úÖ Browser OK' : '‚ùå Missing capabilities',
                allGood ? 'success' : 'error'
            );

            updateSummary();
            return allGood;
        }

        // Test 3: Microphone Permissions
        async function testMicrophone() {
            log('microphone-details', 'üé§ Testing microphone access...');
            setStatus('microphone-status', '‚è≥ Testing microphone...', 'warning');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('microphone-details', '‚úÖ Microphone access granted');
                log('microphone-details', `üîç Audio tracks: ${stream.getAudioTracks().length}`);

                // Test audio constraints
                const tracks = stream.getAudioTracks();
                if (tracks.length > 0) {
                    const settings = tracks[0].getSettings();
                    log('microphone-details', `üîç Audio settings: ${JSON.stringify(settings, null, 2)}`);
                }

                // Clean up
                stream.getTracks().forEach(track => track.stop());

                testResults['Microphone'] = {
                    success: true,
                    message: 'Access granted'
                };

                setStatus('microphone-status', '‚úÖ Microphone OK', 'success');

                // Enable next test
                document.getElementById('test-vapi-load').disabled = false;

            } catch (error) {
                log('microphone-details', `‚ùå Microphone error: ${error.message}`);
                log('microphone-details', `üîç Error name: ${error.name}`);

                if (error.name === 'NotAllowedError') {
                    log('microphone-details', 'üí° Permission denied - user needs to allow microphone access');
                } else if (error.name === 'NotFoundError') {
                    log('microphone-details', 'üí° No microphone found');
                } else {
                    log('microphone-details', 'üí° Check browser permissions and HTTPS requirement');
                }

                testResults['Microphone'] = {
                    success: false,
                    message: error.message
                };

                setStatus('microphone-status', `‚ùå ${error.message}`, 'error');
            }

            updateSummary();
        }

        // Test 4: VAPI SDK Loading
        async function testVapiLoading() {
            log('vapi-load-details', 'üì¶ Testing VAPI SDK loading...');
            setStatus('vapi-load-status', '‚è≥ Loading VAPI SDK...', 'warning');

            try {
                // Try multiple loading methods
                log('vapi-load-details', 'üîç Method 1: Trying dynamic import...');

                // Method 1: Dynamic import
                try {
                    const { default: Vapi } = await import('https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/index.js');
                    log('vapi-load-details', '‚úÖ VAPI loaded via dynamic import');
                    window.Vapi = Vapi;
                } catch (importError) {
                    log('vapi-load-details', `‚ùå Dynamic import failed: ${importError.message}`);

                    // Method 2: Script tag
                    log('vapi-load-details', 'üîç Method 2: Trying script tag...');
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/index.umd.js';
                        script.onload = () => {
                            log('vapi-load-details', '‚úÖ VAPI loaded via script tag');
                            resolve();
                        };
                        script.onerror = () => {
                            log('vapi-load-details', '‚ùå Script tag loading failed');
                            reject(new Error('Script tag loading failed'));
                        };
                        document.head.appendChild(script);
                    });
                }

                // Check if Vapi is available
                if (window.Vapi) {
                    log('vapi-load-details', '‚úÖ VAPI SDK is available in window.Vapi');
                    log('vapi-load-details', `üîç VAPI constructor: ${typeof window.Vapi}`);

                    testResults['VAPI Loading'] = {
                        success: true,
                        message: 'SDK loaded successfully'
                    };

                    setStatus('vapi-load-status', '‚úÖ VAPI SDK Loaded', 'success');

                    // Enable next test
                    document.getElementById('test-vapi-init').disabled = false;

                } else {
                    throw new Error('VAPI SDK not available after loading attempts');
                }

            } catch (error) {
                log('vapi-load-details', `‚ùå VAPI loading error: ${error.message}`);
                log('vapi-load-details', 'üí° This might be CSP (Content Security Policy) blocking the SDK');
                log('vapi-load-details', 'üí° Or network connectivity issues');

                testResults['VAPI Loading'] = {
                    success: false,
                    message: error.message
                };

                setStatus('vapi-load-status', `‚ùå ${error.message}`, 'error');
            }

            updateSummary();
        }

        // Test 5: VAPI Initialization
        async function testVapiInit() {
            log('vapi-init-details', 'üöÄ Testing VAPI initialization...');
            setStatus('vapi-init-status', '‚è≥ Initializing VAPI...', 'warning');

            try {
                const publicKey = import.meta?.env?.VITE_VAPI_PUBLIC_KEY ||
                    '4fba1458-6ea8-45c5-9653-76bbb54e64b5';

                log('vapi-init-details', `üîë Using public key: ${publicKey.substring(0, 10)}...`);

                if (!window.Vapi) {
                    throw new Error('VAPI SDK not loaded');
                }

                vapiInstance = new window.Vapi(publicKey);
                log('vapi-init-details', '‚úÖ VAPI instance created');

                // Set up event listeners
                vapiInstance.on('call-start', () => {
                    log('vapi-init-details', 'üìû Event: call-start');
                });

                vapiInstance.on('call-end', () => {
                    log('vapi-init-details', 'üìû Event: call-end');
                });

                vapiInstance.on('error', (error) => {
                    log('vapi-init-details', `‚ùå Event: error - ${error.message}`);
                });

                vapiInstance.on('message', (message) => {
                    log('vapi-init-details', `üì® Event: message - ${JSON.stringify(message)}`);
                });

                log('vapi-init-details', '‚úÖ Event listeners set up');

                testResults['VAPI Initialization'] = {
                    success: true,
                    message: 'Initialized successfully'
                };

                setStatus('vapi-init-status', '‚úÖ VAPI Initialized', 'success');

                // Enable next test
                document.getElementById('test-vapi-call').disabled = false;

            } catch (error) {
                log('vapi-init-details', `‚ùå VAPI initialization error: ${error.message}`);
                log('vapi-init-details', `üîç Error stack: ${error.stack}`);

                testResults['VAPI Initialization'] = {
                    success: false,
                    message: error.message
                };

                setStatus('vapi-init-status', `‚ùå ${error.message}`, 'error');
            }

            updateSummary();
        }

        // Test 6: VAPI Call
        async function testVapiCall() {
            log('vapi-call-details', 'üìû Testing VAPI call...');
            setStatus('vapi-call-status', '‚è≥ Starting call...', 'warning');

            try {
                if (!vapiInstance) {
                    throw new Error('VAPI instance not available');
                }

                const assistantId = import.meta?.env?.VITE_VAPI_ASSISTANT_ID ||
                    '18414a64-d242-447a-8162-ce3efd2cc8f1';

                log('vapi-call-details', `ü§ñ Using assistant ID: ${assistantId.substring(0, 10)}...`);

                const result = await vapiInstance.start(assistantId);
                log('vapi-call-details', '‚úÖ VAPI call started successfully');
                log('vapi-call-details', `üîç Call result: ${JSON.stringify(result)}`);

                // Wait a bit then stop the call
                setTimeout(async () => {
                    try {
                        await vapiInstance.stop();
                        log('vapi-call-details', '‚úÖ VAPI call stopped');
                    } catch (stopError) {
                        log('vapi-call-details', `‚ö†Ô∏è Error stopping call: ${stopError.message}`);
                    }
                }, 3000);

                testResults['VAPI Call'] = {
                    success: true,
                    message: 'Call started successfully'
                };

                setStatus('vapi-call-status', '‚úÖ VAPI Call Works!', 'success');

            } catch (error) {
                log('vapi-call-details', `‚ùå VAPI call error: ${error.message}`);
                log('vapi-call-details', `üîç Error stack: ${error.stack}`);

                testResults['VAPI Call'] = {
                    success: false,
                    message: error.message
                };

                setStatus('vapi-call-status', `‚ùå ${error.message}`, 'error');
            }

            updateSummary();
        }

        // Test 7: Network Connectivity
        async function testNetwork() {
            log('network-details', 'üåê Testing VAPI API connectivity...');
            setStatus('network-status', '‚è≥ Testing network...', 'warning');

            const endpoints = [
                'https://api.vapi.ai/assistant/18414a64-d242-447a-8162-ce3efd2cc8f1',
                'https://api.vapi.ai/call',
                'https://api.openai.com/v1/models'
            ];

            let successCount = 0;

            for (const endpoint of endpoints) {
                try {
                    log('network-details', `üîç Testing: ${endpoint}`);

                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer 4fba1458-6ea8-45c5-9653-76bbb54e64b5'
                        }
                    });

                    log('network-details', `üì° Response: ${response.status} ${response.statusText}`);

                    if (response.status === 200 || response.status === 401) {
                        // 401 is expected for wrong API key, but shows connectivity works
                        log('network-details', `‚úÖ ${endpoint} - reachable`);
                        successCount++;
                    } else {
                        log('network-details', `‚ö†Ô∏è ${endpoint} - unexpected status`);
                    }

                } catch (error) {
                    log('network-details', `‚ùå ${endpoint} - ${error.message}`);
                }
            }

            const allGood = successCount > 0;

            testResults['Network'] = {
                success: allGood,
                message: `${successCount}/${endpoints.length} endpoints reachable`
            };

            setStatus('network-status',
                allGood ? '‚úÖ Network OK' : '‚ùå Network issues',
                allGood ? 'success' : 'error'
            );

            updateSummary();
        }

        // Initialize tests
        document.addEventListener('DOMContentLoaded', () => {
            // Run initial tests automatically
            checkEnvironment();
            checkBrowser();

            // Set up button event listeners
            document.getElementById('test-microphone').addEventListener('click', testMicrophone);
            document.getElementById('test-vapi-load').addEventListener('click', testVapiLoading);
            document.getElementById('test-vapi-init').addEventListener('click', testVapiInit);
            document.getElementById('test-vapi-call').addEventListener('click', testVapiCall);
            document.getElementById('test-network').addEventListener('click', testNetwork);
        });
    </script>
</body>

</html>