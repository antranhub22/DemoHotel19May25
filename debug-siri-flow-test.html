<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Siri Button Flow Debug</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
        }

        .success {
            color: #00ff00;
        }

        .error {
            color: #ff4444;
        }

        .warning {
            color: #ffaa00;
        }

        .info {
            color: #4488ff;
        }

        button {
            background: #333;
            color: #fff;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }

        button:hover {
            background: #555;
        }

        #logs {
            background: #000;
            color: #00ff00;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            font-size: 12px;
        }

        .highlight {
            background: #333;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” Siri Button Flow Debug Tool</h1>
        <p class="info">This page will help us trace exactly what happens when the Siri button is clicked.</p>

        <div class="step">
            <h3>ğŸ“‹ Instructions:</h3>
            <ol>
                <li>Open your main app in another tab: <span class="highlight">https://yourapp.onrender.com</span></li>
                <li>Open Developer Tools (F12) â†’ Console tab</li>
                <li>Copy and paste the debug script below into the console</li>
                <li>Click the Siri button in your app</li>
                <li>Come back here to see the results</li>
            </ol>
        </div>

        <div class="step">
            <h3>ğŸš€ Debug Script (Copy this to Console):</h3>
            <textarea id="debugScript" readonly
                style="width: 100%; height: 200px; background: #000; color: #00ff00; border: 1px solid #333; padding: 10px; font-family: monospace; font-size: 11px;">
// ğŸ” SIRI BUTTON DEBUG SCRIPT - Paste this in Console on your main app

console.clear();
console.log("===== ğŸ¯ SIRI BUTTON DEBUG STARTED =====");

// Step 1: Environment Check
console.log("1ï¸âƒ£ ENVIRONMENT:");
const envCheck = {
    VITE_FORCE_VAPI_IN_DEV: import.meta?.env?.VITE_FORCE_VAPI_IN_DEV || "MISSING",
    VITE_VAPI_PUBLIC_KEY: import.meta?.env?.VITE_VAPI_PUBLIC_KEY ? "EXISTS" : "MISSING",
    VITE_VAPI_ASSISTANT_ID: import.meta?.env?.VITE_VAPI_ASSISTANT_ID ? "EXISTS" : "MISSING",
    NODE_ENV: import.meta?.env?.NODE_ENV || "unknown"
};
console.table(envCheck);

// Step 2: Capture All Logs
window.__siriLogs = [];
const originalLog = console.log;
const originalError = console.error;

console.log = function(...args) {
    const msg = args.join(' ');
    if (msg.includes('DEBUG') || msg.includes('Siri') || msg.includes('startCall') || msg.includes('VAPI')) {
        window.__siriLogs.push({ type: 'log', time: Date.now(), msg });
    }
    originalLog.apply(console, args);
};

console.error = function(...args) {
    const msg = args.join(' ');
    window.__siriLogs.push({ type: 'error', time: Date.now(), msg });
    originalError.apply(console, args);
};

// Step 3: Find Siri Button
console.log("2ï¸âƒ£ FINDING SIRI BUTTON:");
function findSiriButton() {
    const selectors = [
        '[data-testid*="siri"]',
        '.siri-button', 
        '[class*="siri"]',
        'button[class*="gradient"]',
        'div[class*="gradient"]',
        '.voice-button'
    ];
    
    let found = null;
    selectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        if (elements.length > 0) {
            console.log(`âœ… Found ${elements.length} elements with: ${selector}`);
            elements.forEach((el, i) => {
                console.log(`   ${i + 1}. Tag: ${el.tagName}, Classes: ${el.className}`);
                if (!found) found = el;
            });
        }
    });
    
    if (!found) {
        console.log("âŒ No Siri button found with standard selectors");
        // Try finding by text content
        const buttons = Array.from(document.querySelectorAll('button, div[role="button"]'));
        found = buttons.find(btn => 
            btn.textContent?.includes('ğŸ¤') || 
            btn.className.includes('microphone') ||
            btn.getAttribute('aria-label')?.includes('voice')
        );
        if (found) {
            console.log("âœ… Found button by content/attributes:", found);
        }
    }
    
    return found;
}

const siriButton = findSiriButton();

// Step 4: Add Click Interceptor
if (siriButton) {
    console.log("3ï¸âƒ£ ADDING CLICK INTERCEPTOR:");
    
    // Save original click handlers
    const originalHandlers = [];
    
    // Intercept click events
    siriButton.addEventListener('click', function(event) {
        console.log("ğŸ¯ ===== SIRI BUTTON CLICKED =====");
        console.log("Time:", new Date().toISOString());
        console.log("Event target:", event.target);
        console.log("Event current target:", event.currentTarget);
        
        window.__siriClickTime = Date.now();
        
        // Track what happens in the next 3 seconds
        setTimeout(() => {
            console.log("ğŸ“Š ===== SIRI CLICK RESULTS (3 sec) =====");
            const recentLogs = window.__siriLogs.filter(log => 
                log.time >= window.__siriClickTime
            ).slice(0, 20);
            
            if (recentLogs.length === 0) {
                console.error("âŒ NO LOGS CAPTURED - Handler might not be working");
            } else {
                console.log(`âœ… Captured ${recentLogs.length} relevant logs:`);
                recentLogs.forEach((log, i) => {
                    const time = new Date(log.time).toISOString().split('T')[1];
                    console.log(`${i + 1}. [${time}] ${log.type.toUpperCase()}: ${log.msg}`);
                });
            }
            
            // Also check network requests
            console.log("ğŸŒ Recent Network Activity:");
            if (window.performance?.getEntriesByType) {
                const recentRequests = window.performance.getEntriesByType('navigation')
                    .concat(window.performance.getEntriesByType('resource'))
                    .filter(entry => entry.startTime >= window.__siriClickTime - 1000)
                    .slice(0, 10);
                
                recentRequests.forEach(req => {
                    console.log(`   ${req.name} - ${Math.round(req.duration)}ms`);
                });
            }
        }, 3000);
        
    }, true); // Use capture phase
    
    console.log("âœ… Click interceptor added successfully");
} else {
    console.error("âŒ Cannot add interceptor - no button found");
}

// Step 5: Helper Functions
window.__siriDebug = {
    showLogs: () => {
        console.log("ğŸ“‹ ALL CAPTURED LOGS:");
        window.__siriLogs.forEach((log, i) => {
            console.log(`${i + 1}. ${log.type}: ${log.msg}`);
        });
    },
    clearLogs: () => {
        window.__siriLogs = [];
        console.log("ğŸ—‘ï¸ Logs cleared");
    },
    findButton: findSiriButton,
    clickButton: () => {
        const btn = findSiriButton();
        if (btn) {
            btn.click();
            console.log("ğŸ–±ï¸ Button clicked programmatically");
        } else {
            console.error("âŒ No button to click");
        }
    },
    checkVapi: async () => {
        try {
            const vapi = await import('https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/index.js');
            console.log("âœ… VAPI SDK loadable:", typeof vapi.default);
            return vapi;
        } catch (e) {
            console.error("âŒ VAPI SDK load failed:", e);
            return null;
        }
    }
};

console.log("âœ… Debug setup complete!");
console.log("Available commands:");
console.log("- __siriDebug.showLogs() - Show all captured logs");
console.log("- __siriDebug.clearLogs() - Clear logs");
console.log("- __siriDebug.findButton() - Find Siri button again");
console.log("- __siriDebug.clickButton() - Click button programmatically");
console.log("- __siriDebug.checkVapi() - Test VAPI SDK loading");
console.log("");
console.log("ğŸ¯ Now click the Siri button and wait 3 seconds for analysis!");
            </textarea>
            <br>
            <button onclick="navigator.clipboard.writeText(document.getElementById('debugScript').value)">ğŸ“‹ Copy
                Script</button>
        </div>

        <div class="step">
            <h3>ğŸ”§ Quick Actions:</h3>
            <button onclick="openMainApp()">ğŸš€ Open Main App</button>
            <button onclick="copyScript()">ğŸ“‹ Copy Debug Script</button>
            <button onclick="refreshInstructions()">ğŸ”„ Refresh Instructions</button>
        </div>

        <div class="step">
            <h3>ğŸ“Š Common Issues to Look For:</h3>
            <ul>
                <li class="info">ğŸ” <strong>No logs captured:</strong> Button click handler not working</li>
                <li class="warning">âš ï¸ <strong>Logs but no VAPI call:</strong> Issue in the React context chain</li>
                <li class="error">âŒ <strong>VAPI SDK errors:</strong> CDN loading or configuration issues</li>
                <li class="info">ğŸŒ <strong>Network errors:</strong> CORS or API endpoint issues</li>
                <li class="warning">âš ï¸ <strong>Mock mode logs:</strong> VITE_FORCE_VAPI_IN_DEV not working</li>
            </ul>
        </div>

        <div class="step">
            <h3>ğŸ“ Results Logs:</h3>
            <div id="logs">
                <p class="info">Results from the debug script will appear here...</p>
                <p class="warning">Make sure to run the script in your main app console first!</p>
            </div>
        </div>
    </div>

    <script>
        function openMainApp() {
            // Try to detect current domain or use placeholder
            const domain = window.location.hostname === 'localhost' ?
                'http://localhost:5173' :
                'https://yourapp.onrender.com';
            window.open(domain, '_blank');
        }

        function copyScript() {
            const script = document.getElementById('debugScript');
            script.select();
            document.execCommand('copy');

            // Visual feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'âœ… Copied!';
            button.style.background = '#00aa00';

            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#333';
            }, 2000);
        }

        function refreshInstructions() {
            document.getElementById('logs').innerHTML = `
                <p class="info">Instructions refreshed!</p>
                <p class="warning">1. Open main app in another tab</p>
                <p class="warning">2. Open DevTools Console (F12)</p>
                <p class="warning">3. Copy and paste the debug script</p>
                <p class="warning">4. Click the Siri button in your app</p>
                <p class="info">5. Watch the console for detailed flow analysis</p>
            `;
        }

        // Auto-select script on click
        document.getElementById('debugScript').addEventListener('click', function () {
            this.select();
        });

        // Add some dynamic content
        setInterval(() => {
            const now = new Date().toLocaleTimeString();
            document.title = `ğŸ” Siri Debug Tool - ${now}`;
        }, 1000);

        console.log("ğŸ” Siri Button Debug Tool loaded");
        console.log("ğŸ“‹ Copy the script above and run it in your main app console");
    </script>
</body>

</html>