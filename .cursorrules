# ğŸ¨ Hotel Voice Assistant SaaS Platform - Cursor Rules

## ğŸ“‹ PROJECT OVERVIEW

**DemoHotel19May** lÃ  má»™t há»‡ thá»‘ng quáº£n lÃ½ khÃ¡ch sáº¡n Ä‘a thuÃª bao (multi-tenant SaaS) vá»›i AI voice assistant, Ä‘Æ°á»£c xÃ¢y dá»±ng báº±ng kiáº¿n trÃºc monorepo hiá»‡n Ä‘áº¡i. Dá»± Ã¡n há»— trá»£ nhiá»u khÃ¡ch sáº¡n vá»›i voice assistant riÃªng biá»‡t, tÃ­ch há»£p OpenAI vÃ  Vapi.ai.

### ğŸ—ï¸ KIáº¾N TRÃšC CHÃNH
```
DemoHotel19May/
â”œâ”€â”€ apps/                    # Applications (client React + server Node.js)
â”œâ”€â”€ packages/                # Shared code (types, config, utils)
â”œâ”€â”€ tools/                   # Development tools & scripts
â”œâ”€â”€ docs/                    # Comprehensive documentation
â”œâ”€â”€ tests/                   # Test suites
â””â”€â”€ assets/                  # Static assets
```

---

## ğŸ¯ SSOT (SINGLE SOURCE OF TRUTH) GUIDELINES

### ğŸ› ï¸ AUTOMATION COMMANDS
```bash
# ğŸ” TÃ¬m SSOT files trÆ°á»›c khi thay Ä‘á»•i
npm run find-ssot [keyword]        # TÃ¬m files SSOT liÃªn quan
node scripts/ssot-finder.js        # Interactive SSOT finder  
node scripts/what-to-change.js     # Interactive change wizard

# âœ… Validation & Generation
npm run validate:ssot               # Validate táº¥t cáº£ consistency
npm run generate:types              # Generate TypeScript types
npm run check:breaking-changes      # Check breaking changes
npm run validate:runtime            # Runtime validation
```

### ğŸ“‹ PRIMARY SSOT LOCATIONS

#### ğŸ—„ï¸ DATABASE CHANGES
**PRIMARY**: `packages/shared/db/schema.ts`
**SECONDARY**: tools/migrations/, packages/shared/types/core.ts, schemas/dashboard-schema.json
**AUTOMATION**:
```bash
npm run generate:types              # Generate TypeScript types
npm run check:breaking-changes      # Check breaking changes  
npm run validate:ssot               # Validate consistency
```

#### ğŸ”Œ API CHANGES  
**PRIMARY**: `apps/server/routes/[specific-route].ts`
- `auth.ts` - Authentication routes
- `calls.ts` - Call management  
- `orders.ts` - Order/request management
- `analytics.ts` - Analytics endpoints
- `dashboard.ts` - Dashboard data

**SECONDARY**: schemas/api-schema.json, packages/shared/types/api.ts, docs/API_DOCUMENTATION.md
**AUTOMATION**:
```bash
npm run generate:api-docs           # Update API documentation
npm run validate:runtime --api      # Validate API schema
npm run check:breaking-changes      # For breaking changes
```

#### ğŸ¨ FRONTEND CHANGES
**PRIMARY**: `apps/client/src/components/[component-directory]/`
- `ui/` - Reusable UI components
- `dashboard/` - Dashboard-specific components  
- `unified-dashboard/` - Unified dashboard components

**SECONDARY**: packages/shared/types/ui.ts, apps/client/src/components/index.ts
**AUTOMATION**:
```bash
npm run type-check                  # TypeScript validation
npm run validate:runtime --components # Validate component schemas
```

#### âš™ï¸ CONFIGURATION CHANGES
**PRIMARY**: `.env.example` (environment) hoáº·c `vite.config.ts` (build)
**SECONDARY**: packages/config/environment.ts, apps/server/index.ts
**AUTOMATION**:
```bash
npm run sync:changes                # Sync to all environments
npm run validate:runtime --config  # Validate configuration
```

#### ğŸ“ TYPES & VALIDATION
**PRIMARY**: `packages/shared/types/[specific-type].ts`
**SECONDARY**: schemas/, packages/types/
**AUTOMATION**:
```bash
npm run generate:types             # Auto-generate from schema
npm run validate:ssot              # Validate type consistency
```

---

## ğŸ¨ HOTEL-SPECIFIC FEATURES

### ğŸ™ï¸ VOICE ASSISTANT
**PRIMARY**: `apps/client/src/context/AssistantContext.tsx`
**SECONDARY**: 
- apps/server/services/vapiIntegration.ts
- apps/client/src/components/VoiceAssistant.tsx
- apps/client/src/lib/vapiClient.ts

### ğŸ›ï¸ ROOM SERVICE / ORDERS  
**PRIMARY**: `packages/shared/db/schema.ts` (request table)
**SECONDARY**: 
- apps/server/routes/orders.ts
- apps/client/src/components/EmailForm.tsx
- apps/server/services/orderService.ts

### ğŸ¢ MULTI-TENANT FEATURES
**PRIMARY**: `packages/shared/db/schema.ts` (tenants table)  
**SECONDARY**: 
- apps/server/middleware/tenant.ts
- apps/server/services/tenantService.ts
- apps/client/src/context/AuthContext.tsx

### ğŸ“Š ANALYTICS & REPORTING
**PRIMARY**: `apps/server/routes/analytics.ts`
**SECONDARY**: 
- apps/server/services/analyticsService.ts
- apps/client/src/pages/AnalyticsDashboard.tsx
- schemas/dashboard-schema.json

---

## ğŸ”„ MANDATORY CHANGE PROCESS

### 1. Before Making ANY Changes:
```bash
# ğŸ” Find the right SSOT files first
node scripts/what-to-change.js     # Interactive guidance
# OR
node scripts/ssot-finder.js        # Find specific files
```

### 2. Make Changes to PRIMARY file first, then:
```bash
npm run validate:ssot               # Validate consistency
npm run check:breaking-changes      # Check for breaking changes
```

### 3. Update SECONDARY files as guided by automation

### 4. Before Committing:
```bash
npm run validate:ssot               # Final validation
npm run validate:runtime            # Runtime validation
npm run type-check                  # TypeScript check
```

### 5. For Breaking Changes (REQUIRED):
```bash
npm run generate:migration-guide    # Generate migration guide
npm run generate:migration-docs     # Generate migration docs
```

---

## ğŸš¨ BREAKING CHANGE RULES

### NEVER deploy breaking changes without:
1. âœ… Running `npm run check:breaking-changes`
2. âœ… Running `npm run generate:migration-guide`  
3. âœ… Running `npm run generate:migration-docs`
4. âœ… Reviewing generated migration documentation
5. âœ… Testing migration procedures

### Common Breaking Changes:
- Removing database columns/tables
- Changing API endpoint paths/methods
- Modifying request/response formats
- Removing environment variables
- Changing component props interfaces

---

## ğŸ’» CODING STANDARDS & PATTERNS

### ğŸ¯ TypeScript Standards
```typescript
// âœ… GOOD: Use strict types
interface HotelConfig {
  id: string;
  name: string;
  settings: HotelSettings;
}

// âœ… GOOD: Use proper generics
function createApiClient<T extends ApiConfig>(config: T): ApiClient<T>

// âŒ BAD: Avoid 'any' types
const data: any = response.data;

// âœ… GOOD: Use proper error handling
try {
  const result = await apiCall();
  return { success: true, data: result };
} catch (error) {
  logger.error('API call failed', { error, context });
  throw new ApiError('Failed to fetch data', error);
}
```

### ğŸ”— Import Patterns
```typescript
// âœ… GOOD: Use absolute imports with aliases
import { Component } from '@/components';
import { utils } from '@shared/utils';
import { service } from '@server/services';
import { Config } from '@config/app.config';
import { ApiResponse } from '@types/api';

// âŒ BAD: Avoid relative imports
import { Component } from '../../../components';
import { utils } from '../../shared/utils';
```

### ğŸ—ï¸ Component Architecture
```typescript
// âœ… GOOD: Follow this component structure
import React from 'react';
import { cn } from '@/lib/utils';
import { logger } from '@shared/utils/logger';
import type { ComponentProps } from '@types/ui';

interface Props extends ComponentProps {
  variant: 'primary' | 'secondary';
  children: React.ReactNode;
}

export const MyComponent: React.FC<Props> = ({ 
  variant, 
  children, 
  className, 
  ...props 
}) => {
  return (
    <div 
      className={cn(
        'base-styles',
        variant === 'primary' && 'primary-styles',
        className
      )}
      {...props}
    >
      {children}
    </div>
  );
};
```

### ğŸ”„ State Management
```typescript
// âœ… GOOD: Use React Context for global state
export const AssistantContext = createContext<AssistantContextType | undefined>(undefined);

export const useAssistant = () => {
  const context = useContext(AssistantContext);
  if (!context) {
    throw new Error('useAssistant must be used within AssistantProvider');
  }
  return context;
};

// âœ… GOOD: Use useState for local state
const [isLoading, setIsLoading] = useState(false);
const [error, setError] = useState<string | null>(null);
```

### ğŸ—„ï¸ Database Patterns
```typescript
// âœ… GOOD: Use Drizzle ORM patterns
export const users = sqliteTable("users", {
  id: text("id").primaryKey(),
  tenantId: text("tenant_id").references(() => tenants.id),
  name: text("name").notNull(),
  email: text("email").notNull().unique(),
  createdAt: integer("created_at").default(sql`CURRENT_TIMESTAMP`),
});

// âœ… GOOD: Always filter by tenant
const getUsersByTenant = async (tenantId: string) => {
  return db.select().from(users).where(eq(users.tenantId, tenantId));
};
```

### ğŸ”§ API Patterns
```typescript
// âœ… GOOD: Use proper validation
const createUserSchema = z.object({
  name: z.string().min(1).max(100),
  email: z.string().email(),
  role: z.enum(['admin', 'staff', 'guest'])
});

// âœ… GOOD: Follow API structure
export const createUser = async (req: Request, res: Response) => {
  try {
    const validatedData = createUserSchema.parse(req.body);
    const tenantId = req.tenant?.id;
    
    if (!tenantId) {
      return res.status(400).json({ error: 'Tenant not found' });
    }
    
    const user = await userService.create({ ...validatedData, tenantId });
    logger.success('User created', { userId: user.id, tenantId });
    
    res.status(201).json({ success: true, data: user });
  } catch (error) {
    logger.error('Failed to create user', { error, body: req.body });
    res.status(500).json({ error: 'Internal server error' });
  }
};
```

---

## ğŸ¨ UI/UX STANDARDS

### ğŸ­ Component Naming
```typescript
// âœ… GOOD: PascalCase for components
export const VoiceAssistantPanel = () => {};
export const HotelConfigurationForm = () => {};
export const StaffDashboardLayout = () => {};

// âœ… GOOD: camelCase for hooks
export const useHotelConfiguration = () => {};
export const useVoiceAssistant = () => {};
export const useMultiTenant = () => {};
```

### ğŸ¨ Styling Patterns
```typescript
// âœ… GOOD: Use Tailwind CSS with cn utility
import { cn } from '@/lib/utils';

const buttonVariants = {
  primary: 'bg-blue-600 hover:bg-blue-700 text-white',
  secondary: 'bg-gray-200 hover:bg-gray-300 text-gray-900',
  danger: 'bg-red-600 hover:bg-red-700 text-white'
};

export const Button = ({ variant = 'primary', className, ...props }) => (
  <button 
    className={cn(
      'px-4 py-2 rounded-md font-medium transition-colors',
      buttonVariants[variant],
      className
    )}
    {...props}
  />
);
```

### ğŸŒ Internationalization
```typescript
// âœ… GOOD: Support multiple languages
export type Language = 'en' | 'vi' | 'fr' | 'zh' | 'ru' | 'ko';

export const translations = {
  en: { welcome: 'Welcome to Mi Nhon Hotel' },
  vi: { welcome: 'ChÃ o má»«ng Ä‘áº¿n Mi Nhon Hotel' },
  fr: { welcome: 'Bienvenue Ã  Mi Nhon Hotel' }
};

// âœ… GOOD: Use language context
export const useTranslation = (language: Language) => {
  return translations[language] || translations.en;
};
```

---

## ğŸ§ª TESTING REQUIREMENTS

### ğŸ”§ Test Structure
```typescript
// âœ… GOOD: Follow test patterns
describe('HotelService', () => {
  beforeEach(() => {
    // Setup test data
  });

  describe('createHotel', () => {
    it('should create hotel successfully', async () => {
      const hotelData = { name: 'Test Hotel', location: 'Test City' };
      const result = await hotelService.create(hotelData);
      
      expect(result.success).toBe(true);
      expect(result.data.name).toBe(hotelData.name);
    });

    it('should handle validation errors', async () => {
      const invalidData = { name: '' }; // Invalid name
      await expect(hotelService.create(invalidData)).rejects.toThrow();
    });
  });
});
```

### ğŸ“Š Integration Testing
```bash
# Run integration tests
npm run test:integration

# Run specific test suites
npm run test:hotel-features
npm run test:voice-assistant
npm run test:multi-tenant
```

---

## ğŸ” SECURITY GUIDELINES

### ğŸ›¡ï¸ Authentication & Authorization
```typescript
// âœ… GOOD: Always verify JWT tokens
export const verifyJWT = (req: Request, res: Response, next: NextFunction) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }
  
  try {
    const decoded = jwt.verify(token, JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
};

// âœ… GOOD: Always filter by tenant
export const enforceRowLevelSecurity = (req: Request, res: Response, next: NextFunction) => {
  req.tenant = getTenantFromToken(req.user);
  next();
};
```

### ğŸ”’ Data Validation
```typescript
// âœ… GOOD: Validate all inputs
import { z } from 'zod';

export const hotelSchema = z.object({
  name: z.string().min(1).max(100),
  location: z.string().min(1).max(200),
  phone: z.string().regex(/^\+?[\d\s\-\(\)]+$/),
  email: z.string().email()
});

// âœ… GOOD: Sanitize user inputs
export const sanitizeInput = (input: string): string => {
  return input.trim().replace(/<script[^>]*>.*?<\/script>/gi, '');
};
```

---

## ğŸš€ DEPLOYMENT & ENVIRONMENT

### ğŸŒ Environment Variables
```bash
# Core Settings
NODE_ENV=production
PORT=10000
DATABASE_URL=postgresql://...

# Authentication
JWT_SECRET=your-super-secret-key
STAFF_ACCOUNTS=admin:password,staff:password

# AI Services
VITE_OPENAI_API_KEY=sk-...
VITE_VAPI_PUBLIC_KEY=pk-...
VITE_VAPI_ASSISTANT_ID=asst-...

# Multi-language Support
VITE_VAPI_PUBLIC_KEY_VI=pk-...
VITE_VAPI_ASSISTANT_ID_VI=asst-...

# SaaS Features
GOOGLE_PLACES_API_KEY=...
MAILJET_API_KEY=...
```

### ğŸ“¦ Build & Deploy
```bash
# Development
npm run dev                    # Start development servers
npm run dev:client            # Start only frontend
npm run dev:server            # Start only backend

# Production Build
npm run build                 # Build for production
npm run start                 # Start production server
npm run preview              # Preview production build

# Deployment
./deploy-render.sh           # Deploy to Render
./deploy-build.sh            # Build and deploy
```

---

## ğŸ“š DOCUMENTATION REQUIREMENTS

### ğŸ“ Code Documentation
```typescript
/**
 * Hotel Research Service
 * 
 * Automatically researches hotel information using multiple data sources
 * including Google Places API, website scraping, and social media.
 * 
 * @example
 * ```typescript
 * const service = new HotelResearchService();
 * const hotelData = await service.basicResearch('Mi Nhon Hotel', 'Mui Ne');
 * ```
 */
export class HotelResearchService {
  /**
   * Performs basic hotel research using free APIs
   * 
   * @param hotelName - Name of the hotel to research
   * @param location - Optional location for better search results
   * @returns Promise containing basic hotel information
   */
  async basicResearch(hotelName: string, location?: string): Promise<BasicHotelData> {
    // Implementation...
  }
}
```

### ğŸ“– API Documentation
```typescript
/**
 * @api {post} /api/hotels Create Hotel
 * @apiName CreateHotel
 * @apiGroup Hotels
 * @apiVersion 1.0.0
 * 
 * @apiHeader {String} Authorization Bearer token
 * @apiHeader {String} Content-Type application/json
 * 
 * @apiParam {String} name Hotel name (1-100 characters)
 * @apiParam {String} location Hotel location
 * @apiParam {String} [description] Hotel description
 * 
 * @apiSuccess {Boolean} success Success status
 * @apiSuccess {Object} data Hotel data
 * @apiSuccess {String} data.id Hotel ID
 * @apiSuccess {String} data.name Hotel name
 * 
 * @apiError {String} error Error message
 * @apiError {Number} code Error code
 */
```

---

## ğŸ†˜ TROUBLESHOOTING WHEN STUCK

### ğŸ” Finding the Right Files
```bash
# 1. Use interactive guidance
node scripts/what-to-change.js

# 2. Find specific files
node scripts/ssot-finder.js

# 3. Check consistency
npm run validate:ssot

# 4. Check complete mapping
cat config/ssot-registry.json
```

### ğŸ“š Key Documentation Files
- **Architecture**: `docs/ARCHITECTURE.md`
- **API Docs**: `docs/API_DOCUMENTATION.md` (auto-generated)
- **Deployment**: `docs/DEPLOYMENT_QUICKSTART.md`
- **Onboarding**: `docs/ONBOARDING_GUIDE.md`
- **SSOT Registry**: `config/ssot-registry.json`

### ğŸ¯ Quick Commands Reference
```bash
# Development
npm run dev                    # Start full development
npm run type-check            # TypeScript validation
npm run lint:check            # Code linting

# SSOT & Validation
npm run validate:ssot         # Validate consistency
npm run find-ssot [keyword]   # Find SSOT files
npm run check:breaking-changes # Check breaking changes

# Generation & Sync
npm run generate:types        # Generate types
npm run generate:api-docs     # Generate API docs
npm run sync:changes          # Sync between environments
```

---

## ğŸ¯ SUMMARY

**DemoHotel19May** lÃ  má»™t SaaS platform sophisticated vá»›i:

- **ğŸ—ï¸ Monorepo Architecture**: apps/, packages/, tools/, docs/
- **ğŸ¤– AI Integration**: OpenAI + Vapi.ai voice assistants
- **ğŸ¢ Multi-tenant**: Isolated data and functionality per hotel
- **ğŸŒ Multi-language**: 6 languages supported
- **ğŸ“Š Analytics**: Comprehensive reporting and dashboards
- **ğŸ¨ Modern UI**: React + TypeScript + Tailwind CSS
- **ğŸ”’ Security**: JWT authentication + RBAC
- **ğŸ“± Real-time**: WebSocket communication
- **ğŸ—„ï¸ Database**: PostgreSQL/SQLite with Drizzle ORM

**ğŸ¯ Remember: CONSISTENCY is key. Always use SSOT automation to maintain system integrity!**

---

## âš¡ PERFORMANCE GUIDELINES

### ğŸš€ Frontend Optimization
```typescript
// âœ… GOOD: Use React.memo for expensive components
export const ExpensiveComponent = React.memo(({ data }) => {
  return <div>{/* Complex rendering */}</div>;
});

// âœ… GOOD: Use useMemo for expensive calculations
const expensiveValue = useMemo(() => {
  return data.reduce((acc, item) => acc + item.value, 0);
}, [data]);

// âœ… GOOD: Use lazy loading for routes
const LazyDashboard = lazy(() => import('@/pages/Dashboard'));
```

### ğŸ—„ï¸ Database Optimization
```typescript
// âœ… GOOD: Use indexes for frequently queried columns
export const users = sqliteTable("users", {
  id: text("id").primaryKey(),
  tenantId: text("tenant_id").references(() => tenants.id), // Add index
  email: text("email").notNull().unique(), // Already indexed
  createdAt: integer("created_at").default(sql`CURRENT_TIMESTAMP`),
}, (table) => ({
  tenantIdx: index("users_tenant_idx").on(table.tenantId),
  emailIdx: index("users_email_idx").on(table.email),
}));

// âœ… GOOD: Limit query results
const getRecentCalls = async (tenantId: string, limit = 100) => {
  return db.select()
    .from(calls)
    .where(eq(calls.tenantId, tenantId))
    .orderBy(desc(calls.createdAt))
    .limit(limit);
};
```

### ğŸ”„ API Optimization
```typescript
// âœ… GOOD: Use caching for expensive operations
import NodeCache from 'node-cache';
const cache = new NodeCache({ stdTTL: 300 }); // 5 minutes

export const getHotelData = async (hotelId: string) => {
  const cacheKey = `hotel:${hotelId}`;
  let hotelData = cache.get(cacheKey);
  
  if (!hotelData) {
    hotelData = await db.select().from(hotels).where(eq(hotels.id, hotelId));
    cache.set(cacheKey, hotelData);
  }
  
  return hotelData;
};

// âœ… GOOD: Use compression for API responses
import compression from 'compression';
app.use(compression());
```

---

*ğŸ¯ Goal: Maintain consistency, follow SSOT principles, and deliver exceptional hotel management experiences through AI-powered voice assistants!* 