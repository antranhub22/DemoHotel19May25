# ============================================================================
# Repository Synchronization Validation
# Automated validation of repository consistency using Repository Sync Checker
# ============================================================================

name: ğŸ”„ Repository Sync Check

on:
  push:
    branches: [ main, develop, staging, refactor-* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      validation_mode:
        description: 'Validation mode (quick, full, deep)'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - full  
          - deep

# Cancel previous runs for the same branch
concurrency:
  group: repository-sync-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  VALIDATION_MODE: ${{ github.event.inputs.validation_mode || 'full' }}

jobs:
  # ======================== Repository Sync Validation ========================
  sync-check:
    name: ğŸ” Repository Sync Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # -------------------- Setup --------------------
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full git history for proper analysis
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          # Install additional validation tools
          npm install -g depcheck madge typescript
          
      # -------------------- Core Validation Checks --------------------
      - name: ğŸ” TypeScript Compilation Check
        run: |
          echo "ğŸ” Checking TypeScript compilation..."
          npx tsc --noEmit --project tsconfig.json
          echo "âœ… TypeScript compilation check passed"
          
      - name: ğŸ“¦ Dependency Validation
        run: |
          echo "ğŸ“¦ Checking for unused dependencies..."
          npx depcheck --ignores="@types/*,prettier,eslint*" || echo "âš ï¸ Dependency check completed with warnings"
          echo "âœ… Dependency validation completed"
          
      - name: ğŸ”„ Circular Dependency Detection
        run: |
          echo "ğŸ”„ Checking for circular dependencies..."
          # Check both client and server
          npx madge --circular apps/client/src/ || echo "âš ï¸ Client circular dependencies detected"
          npx madge --circular apps/server/ || echo "âš ï¸ Server circular dependencies detected"
          npx madge --circular packages/ || echo "âš ï¸ Packages circular dependencies detected"
          echo "âœ… Circular dependency check completed"
          
      - name: ğŸ§¹ ESLint Validation
        run: |
          echo "ğŸ§¹ Running ESLint validation..."
          npm run lint || echo "âš ï¸ ESLint validation failed but continuing..."
          echo "âœ… ESLint validation completed"
          
      # -------------------- Repository Sync Checker Integration --------------------
      - name: ğŸ”„ Repository Sync Checker - Quick Analysis
        if: env.VALIDATION_MODE == 'quick'
        run: |
          echo "ğŸš€ Running Repository Sync Checker (Quick Mode)..."
          npm run sync:check:quick
          
      - name: ğŸ”„ Repository Sync Checker - Full Analysis
        if: env.VALIDATION_MODE == 'full'
        run: |
          echo "ğŸš€ Running Repository Sync Checker (Full Mode)..."
          npm run sync:check
          
      - name: ğŸ”„ Repository Sync Checker - Deep Analysis
        if: env.VALIDATION_MODE == 'deep'
        run: |
          echo "ğŸš€ Running Repository Sync Checker (Deep Mode)..."
          npm run sync:check:deep
          
      # -------------------- Generate Analysis Report --------------------
      - name: ğŸ“Š Generate Comprehensive Report
        run: |
          echo "ğŸ“Š Generating comprehensive validation report..."
          node tools/scripts/validation/repository-sync-checker.js --save --output=ci-validation-report.json
          
      - name: ğŸ“¤ Upload Validation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: repository-sync-report-${{ github.run_number }}
          path: ci-validation-report.json
          retention-days: 30
          
      # -------------------- Git Consistency Validation --------------------
      - name: ğŸ”€ Git Consistency Check
        run: |
          echo "ğŸ”€ Checking git repository consistency..."
          # Check for uncommitted files (should be clean in CI)
          if [ -n "$(git status --porcelain)" ]; then
            echo "âŒ Repository has uncommitted changes after validation"
            git status --porcelain
            exit 1
          fi
          
          # Check for merge conflicts
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "âŒ Repository has unresolved merge conflicts"
            git diff --name-only --diff-filter=U
            exit 1
          fi
          
          echo "âœ… Git consistency check passed"
          
      # -------------------- Performance and Metrics --------------------
      - name: ğŸ“ˆ Performance Metrics
        run: |
          echo "ğŸ“ˆ Collecting performance metrics..."
          echo "Repository size: $(du -sh . | cut -f1)"
          echo "Node modules size: $(du -sh node_modules 2>/dev/null | cut -f1 || echo 'N/A')"
          echo "TypeScript files: $(find . -name '*.ts' -o -name '*.tsx' | wc -l)"
          echo "JavaScript files: $(find . -name '*.js' -o -name '*.jsx' | wc -l)"
          
  # ======================== Extended Validation (Optional) ========================
  extended-validation:
    name: ğŸ”¬ Extended Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: sync-check
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ” File Structure Validation
        run: |
          echo "ğŸ” Validating file structure patterns..."
          # Check for required files
          test -f package.json || (echo "âŒ Missing package.json" && exit 1)
          test -f tsconfig.json || (echo "âŒ Missing tsconfig.json" && exit 1)
          test -f .eslintrc.js || test -f .eslintrc.json || (echo "âŒ Missing ESLint config" && exit 1)
          
          # Check directory structure
          test -d apps/client/src || (echo "âŒ Missing client src directory" && exit 1)
          test -d apps/server || (echo "âŒ Missing server directory" && exit 1)
          test -d packages || (echo "âŒ Missing packages directory" && exit 1)
          
          echo "âœ… File structure validation passed"
          
      - name: ğŸ¯ Import/Export Consistency
        run: |
          echo "ğŸ¯ Checking import/export consistency..."
          # Run specialized import/export checks if available
          if [ -f "tools/scripts/validation/import-export-checker.js" ]; then
            node tools/scripts/validation/import-export-checker.js
          else
            echo "â„¹ï¸ Import/export checker not available, using basic validation"
          fi
          
      - name: ğŸ“ Naming Convention Validation
        run: |
          echo "ğŸ“ Checking naming conventions..."
          # Check for common naming issues
          find apps/client/src/components -name "*.tsx" ! -name "[A-Z]*" | head -5 | while read file; do
            echo "âš ï¸ Component file should start with uppercase: $file"
          done
          
          find apps/client/src/hooks -name "*.ts" ! -name "use*" | head -5 | while read file; do
            echo "âš ï¸ Hook file should start with 'use': $file"
          done
          
  # ======================== Security and Quality Gates ========================
  security-quality:
    name: ğŸ›¡ï¸ Security & Quality Gates
    runs-on: ubuntu-latest
    needs: sync-check
    timeout-minutes: 8
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ›¡ï¸ Security Audit
        run: |
          echo "ğŸ›¡ï¸ Running security audit..."
          npm audit --audit-level=moderate
          
      - name: ğŸ“Š Bundle Size Analysis
        run: |
          echo "ğŸ“Š Analyzing bundle size impact..."
          # Basic bundle size check
          npm run build --if-present || echo "â„¹ï¸ Build command not available"
          
      - name: ğŸ§ª Type Coverage Analysis
        run: |
          echo "ğŸ§ª Analyzing TypeScript type coverage..."
          # Check for any usage that might impact type safety
          grep -r ": any" apps/ packages/ || echo "âœ… No explicit 'any' types found"
          grep -r "@ts-ignore" apps/ packages/ || echo "âœ… No @ts-ignore comments found"

  # ======================== Results Summary ========================
  summary:
    name: ğŸ“‹ Validation Summary
    runs-on: ubuntu-latest
    needs: [sync-check, extended-validation, security-quality]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate Summary
        run: |
          echo "ğŸ“‹ Repository Sync Validation Summary"
          echo "====================================="
          echo "ğŸ” Core Validation: ${{ needs.sync-check.result }}"
          echo "ğŸ”¬ Extended Validation: ${{ needs.extended-validation.result }}"
          echo "ğŸ›¡ï¸ Security & Quality: ${{ needs.security-quality.result }}"
          echo ""
          
          if [ "${{ needs.sync-check.result }}" = "success" ] && 
             [ "${{ needs.extended-validation.result }}" != "failure" ] && 
             [ "${{ needs.security-quality.result }}" != "failure" ]; then
            echo "âœ… All repository sync validations passed!"
            echo "ğŸš€ Repository is ready for deployment"
          else
            echo "âŒ Some validations failed"
            echo "ğŸ”§ Please review the failed checks above"
          fi 